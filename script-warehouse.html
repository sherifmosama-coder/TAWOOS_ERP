<script>
// =============================================================================
// WAREHOUSE MODULE - FRONTEND JAVASCRIPT
// =============================================================================

let warehouseData = {
    allRecords: [],
    filteredRecords: [],
    masterProducts: [],
    laborList: [],
    expandedCards: new Set()
};

// =============================================================================
// INITIALIZATION
// =============================================================================

// Helper to get local date string (YYYY-MM-DD) correctly
// Fixes the "Midnight Bug" caused by UTC conversion
function getLocalTodayDate() {
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// =============================================================================
// INITIALIZATION
// =============================================================================

function initializeWarehouseModule() {
    console.log('Initializing warehouse module (Force Refresh)...');
    
    // FIX: Clear local data to ensure fresh load from server (solves misalignment)
    // This forces handleWarehouseDataLoaded to accept the new server data
    warehouseData.allRecords = [];
    warehouseData.filteredRecords = [];
    warehouseData.expandedCards = new Set(); // Reset UI state (collapse all)

    // Show loading UI
    showWarehouseLoading(true);
    
    // Parallel Loading: Labor List + Warehouse Records (Default: Today + Unsaved)
    Promise.all([
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getLaborList();
        }),
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getWarehouseReleaseRecords(); // No date arg = Default Mode (Today)
        })
    ]).then(([laborResult, warehouseResult]) => {
        // 1. Handle Labor List
        handleLaborListLoaded(laborResult);
        
        // 2. Handle Warehouse Data
        handleWarehouseDataLoaded(warehouseResult);
        
    }).catch(error => {
        handleWarehouseError(error);
    });
}

function handleWarehouseDataLoaded(result) {
    console.log('Warehouse data loaded:', result);
    
    if (!result.success) {
        showToast(result.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        showWarehouseLoading(false);
        return;
    }
    
    // Merge new records with existing ones (to avoid losing unsaved local edits if any)
    // If it's the initial load, this just sets the data.
    if (!warehouseData.allRecords) warehouseData.allRecords = [];
    
    // Re-assign products list (master list)
    warehouseData.masterProducts = result.products || []; 
    
    // Smart Merge: Only add records if they don't exist in current state
    // This allows appending "History" records to "Today's" records without overwrite
    const existingIds = new Set(warehouseData.allRecords.map(r => r.dismissNumber));
    
    (result.records || []).forEach(record => {
        if (!existingIds.has(record.dismissNumber)) {
            warehouseData.allRecords.push(record);
        } else {
            // Optional: Update existing record if needed, but usually preserve local state
            // For now, we skip to protect local edits.
        }
    });
    
    applyDefaultFilter();
    populateWarehouseFilters();
    renderWarehouseCards(); 
    
    showWarehouseLoading(false);
}

// Function to handle deep searching for history
function searchWarehouseHistory() {
    const start = document.getElementById('warehouse-filter-date-start').value;
    const end = document.getElementById('warehouse-filter-date-end').value;
    
    if (!start) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡" Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', 'warning');
        return;
    }

    showWarehouseLoading(true);
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØªØ±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...', 'info');

    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                handleWarehouseDataLoaded(result); // Matches the merge logic we discussed
                showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${result.records.length} Ø³Ø¬Ù„`, 'success');
            } else {
                showToast(result.message, 'error');
                showWarehouseLoading(false);
            }
        })
        .withFailureHandler(handleWarehouseError)
        // FIX: Pass BOTH start and end dates to the backend
        .getWarehouseReleaseRecords(start, end); 
}

function handleLaborListLoaded(result) {
    if (result.success) {
        warehouseData.laborList = result.laborList || [];
    }
}

function handleWarehouseError(error) {
    console.error('Warehouse error:', error);
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
    showWarehouseLoading(false);
}

// =============================================================================
// FILTERING
// =============================================================================

function applyDefaultFilter() {
    // FIX: Use local date helper
    const today = getLocalTodayDate();
    
    // 2. Filter: Today OR Unsaved (No PDF URL in Col H)
    warehouseData.filteredRecords = warehouseData.allRecords.filter(record => {
        const isToday = record.loadingDate === today;
        const isUnsaved = !record.pdfUrl || record.pdfUrl.trim() === '';
        
        return isToday || isUnsaved;
    });

    console.log(`Default Filter Applied: ${warehouseData.filteredRecords.length} records found.`);

    // 3. Update UI Description
    updateFilterDescription('Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø£Ùˆ Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª (ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)');
    
    // 4. Render
    renderWarehouseCards();
}

function populateWarehouseFilters() {
    // Trucks & Drivers (Existing logic...)
    const trucks = [...new Set(warehouseData.allRecords.map(r => r.truckDriverRep.split('-')[0]?.trim()).filter(Boolean))];
    const drivers = [...new Set(warehouseData.allRecords.map(r => r.truckDriverRep.split('-')[1]?.trim()).filter(Boolean))];
    
    const truckSelect = document.getElementById('warehouse-filter-truck');
    truckSelect.innerHTML = '<option value="">Ø§Ù„Ø³ÙŠØ§Ø±Ø© - Ø§Ù„ÙƒÙ„</option>';
    trucks.forEach(t => truckSelect.innerHTML += `<option value="${t}">${t}</option>`);

    const driverSelect = document.getElementById('warehouse-filter-driver');
    driverSelect.innerHTML = '<option value="">Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ø§Ù„ÙƒÙ„</option>';
    drivers.forEach(d => driverSelect.innerHTML += `<option value="${d}">${d}</option>`);

    // NEW: Products Multi-Select
    const productSelect = document.getElementById('warehouse-filter-products');
    productSelect.innerHTML = ''; 
    
    if (warehouseData.masterProducts) {
        warehouseData.masterProducts.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.name;
            opt.text = p.name;
            productSelect.appendChild(opt);
        });
    }
}

// =============================================================================
// FILTER LOGIC
// =============================================================================

function updateProductSummaryDisplay() {
    const select = document.getElementById('warehouse-filter-products');
    const summaryDiv = document.getElementById('product-selection-summary');
    
    if (!select || !summaryDiv) return;
    
    const selectedOptions = Array.from(select.selectedOptions);
    if (selectedOptions.length > 0) {
        const names = selectedOptions.map(opt => opt.text).join('ØŒ ');
        summaryDiv.textContent = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ (${selectedOptions.length}): ${names}`;
        summaryDiv.style.display = 'block';
    } else {
        summaryDiv.textContent = '';
        summaryDiv.style.display = 'none';
    }
}

function applyWarehouseFilters() {
    // 1. Get Values
    const dismissVal = document.getElementById('warehouse-filter-dismiss').value.trim();
    const orderVal = document.getElementById('warehouse-filter-order').value.trim();
    const truckVal = document.getElementById('warehouse-filter-truck').value;
    const driverVal = document.getElementById('warehouse-filter-driver').value;
    const statusVal = document.getElementById('warehouse-filter-status').value;
    
    const dateStart = document.getElementById('warehouse-filter-date-start').value;
    const dateEnd = document.getElementById('warehouse-filter-date-end').value;
    const saveStatus = document.getElementById('warehouse-filter-save-status').value; 
    const completion = document.getElementById('warehouse-filter-completion').value;
    
    const returnDate = document.getElementById('warehouse-filter-return-date').value;
    const returnMismatch = document.getElementById('warehouse-filter-return-mismatch').checked;
    
    const productSelect = document.getElementById('warehouse-filter-products');
    const selectedProducts = Array.from(productSelect.selectedOptions).map(opt => opt.value);

    console.log('--- Applying Filters ---');
    console.log('Active Filters:', { 
        dismissVal, dateStart, dateEnd, saveStatus, completion, returnMismatch, 
        products: selectedProducts.length 
    });

    // 2. Filter Logic
    warehouseData.filteredRecords = warehouseData.allRecords.filter(record => {
        let matches = true;
        let failReason = '';

        // Text Matchers
        if (dismissVal && !record.dismissNumber.includes(dismissVal)) {
            matches = false; failReason = 'Dismiss Number';
        }
        if (matches && orderVal && !record.orderIds.includes(orderVal)) {
            matches = false; failReason = 'Order ID';
        }
        if (matches && statusVal && record.status !== statusVal) {
            matches = false; failReason = 'Status';
        }
        
        // Logistics Matchers
        if (matches) {
            const parts = record.truckDriverRep.split('-');
            if (truckVal && (parts[0] || '').trim() !== truckVal) {
                matches = false; failReason = 'Truck';
            }
            if (matches && driverVal && (parts[1] || '').trim() !== driverVal) {
                matches = false; failReason = 'Driver';
            }
        }

        // Date Range (Inclusive) - Compare strings YYYY-MM-DD
        if (matches && dateStart && record.loadingDate < dateStart) {
            matches = false; failReason = 'Date Before Start';
        }
        if (matches && dateEnd && record.loadingDate > dateEnd) {
            matches = false; failReason = 'Date After End';
        }

        // Save Status (Col H check)
        // A record is "Saved" if pdfUrl is present and > 5 chars
        const isSaved = record.pdfUrl && record.pdfUrl.length > 5;
        if (matches) {
            if (saveStatus === 'draft' && isSaved) {
                matches = false; failReason = 'Is Saved (User wanted Draft)';
            }
            if (saveStatus === 'saved' && !isSaved) {
                matches = false; failReason = 'Is Draft (User wanted Saved)';
            }
        }

        // Completion Status (Col J check)
        if (matches) {
            if (completion === 'complete' && record.recordStatus !== true) {
                matches = false; failReason = 'Not Complete';
            }
            if (completion === 'incomplete' && record.recordStatus !== false) {
                matches = false; failReason = 'Not Incomplete';
            }
            if (completion === 'pending' && record.recordStatus !== null && record.recordStatus !== '') {
                // Pending means null/empty
                matches = false; failReason = 'Not Pending';
            }
        }

        // Return Date Logic
        if (matches && returnDate && record.returnDate !== returnDate) {
            matches = false; failReason = 'Return Date Mismatch';
        }
        
        // Return Mismatch Checkbox
        // Logic: Show ONLY if (Has Return Date) AND (Return Date != Loading Date)
        if (matches && returnMismatch) {
            if (!record.returnDate) {
                matches = false; failReason = 'No Return Date (cannot be mismatch)';
            } else if (record.returnDate === record.loadingDate) {
                matches = false; failReason = 'Dates Match (User wanted mismatch)';
            }
        }

        // Product Content Filter
        // Keep record if it contains ANY of the selected products
        if (matches && selectedProducts.length > 0) {
            const recordProductNames = record.products.map(p => p.name);
            const hasProduct = selectedProducts.some(p => recordProductNames.includes(p));
            if (!hasProduct) {
                matches = false; failReason = 'Product Not Found';
            }
        }

        if (!matches) {
            // Uncomment to debug specific hidden records
            console.log(`Hiding ${record.dismissNumber}: ${failReason}`);
        }

        return matches;
    });

    console.log(`Filtered Result: ${warehouseData.filteredRecords.length} / ${warehouseData.allRecords.length}`);

    // 3. UI Updates
    const desc = buildDetailedFilterDescription({
        dateStart, dateEnd, saveStatus, completion, returnMismatch, selectedProducts, dismissVal
    });
    updateFilterDescription(desc);
    
    renderWarehouseCards();
}

// Helper to create readable summary
function buildDetailedFilterDescription(f) {
    let parts = [];
    if (f.dismissVal) parts.push(`Ø±Ù‚Ù…: ${f.dismissVal}`);
    if (f.dateStart || f.dateEnd) parts.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${f.dateStart || '..'} Ø¥Ù„Ù‰ ${f.dateEnd || '..'}`);
    if (f.saveStatus) parts.push(f.saveStatus === 'saved' ? 'Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©' : 'Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª');
    if (f.completion) parts.push(f.completion);
    if (f.returnMismatch) parts.push('ØªØ§Ø±ÙŠØ® Ø§Ø±ØªØ¬Ø§Ø¹ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚');
    if (f.selectedProducts.length > 0) parts.push(`Ù…Ù†ØªØ¬Ø§Øª (${f.selectedProducts.length})`);
    
    return parts.length > 0 ? `ØªØµÙÙŠØ©: ${parts.join(' | ')}` : 'Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©';
}

function resetWarehouseFilters() {
    // 1. Reset Inputs
    document.getElementById('warehouse-filter-dismiss').value = '';
    document.getElementById('warehouse-filter-date-start').value = ''; // Reset range
    document.getElementById('warehouse-filter-date-end').value = '';
    document.getElementById('warehouse-filter-return-date').value = '';
    document.getElementById('warehouse-filter-return-mismatch').checked = false;
    
    // Reset Selects
    document.querySelectorAll('.warehouse-filter-panel select').forEach(s => s.value = '');
    
    // Clear product summary
    updateProductSummaryDisplay();

    // 2. Apply Default Logic immediately
    applyDefaultFilter(); 
    
    // 3. Render immediately
    renderWarehouseCards();
}

function updateFilterDescription(text) {
    const filterText = document.getElementById('warehouse-filter-text');
    if (filterText) {
        filterText.textContent = text;
    }
}

function buildFilterDescription(dismiss, date, truck, driver, order, status) {
    const parts = [];
    
    if (dismiss) parts.push(`Ø±Ù‚Ù… Ø§Ù„ØµØ±Ù: ${dismiss}`);
    if (date) parts.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`);
    if (truck) parts.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${truck}`);
    if (driver) parts.push(`Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driver}`);
    if (order) parts.push(`Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${order}`);
    if (status) parts.push(`Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`);
    
    if (parts.length === 0) {
        return 'Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª';
    }
    
    return 'ØªØµÙÙŠØ©: ' + parts.join(' | ');
}

// =============================================================================
// CARD RENDERING
// =============================================================================

// =============================================================================
// RENDERING & DATA BINDING FIX
// =============================================================================

function renderWarehouseCards() {
    const container = document.getElementById('warehouse-cards-container');
    const noRecordsMsg = document.getElementById('warehouse-no-records');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (warehouseData.filteredRecords.length === 0) {
        container.style.display = 'none';
        noRecordsMsg.style.display = 'flex';
        return;
    }
    
    container.style.display = 'block';
    noRecordsMsg.style.display = 'none';

    // 1. Sort the records for display
    // We update the main filteredRecords array to match the visual sort order
    // This ensures index 0 in UI = index 0 in Data
    warehouseData.filteredRecords.sort((a, b) => {
        return parseInt(a.dismissNumber) - parseInt(b.dismissNumber);
    });

    warehouseData.filteredRecords.forEach((record, index) => {
        // Pass index, but we will primarily rely on Dismiss Number for lookups
        const cardHtml = createWarehouseCard(record, index);
        container.innerHTML += cardHtml;
    });
    updateWarehouseStats();
}

function handleWarehouseQtyChange(input, dismissNumber, productIndex) {
    // 1. Find the exact record by Unique ID (Dismiss Number)
    // This prevents the "Card A updates Card B" bug
    const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
    
    if (!record) {
        console.error('Record not found for dismiss:', dismissNumber);
        return;
    }

    // 2. Update the data model
    const newQty = parseFloat(input.value);
    // Handle NaN (empty input) as 0, but keep null/undefined distinct if needed
    record.products[productIndex].loadedQty = isNaN(newQty) ? 0 : newQty;

    // 3. Trigger Global Recalculation
    // Because available stock depends on ALL cards, we must refresh indicators for everyone
    updateAvailableStockDisplay();
    updateWarehouseStats();
    
    // 4. Re-validate this specific card to update its Save button status
    // We find the DOM index dynamically to ensure we target the right card
    const currentCardIndex = warehouseData.filteredRecords.indexOf(record);
    validateCardInputs(currentCardIndex);
    updateCardSaveButton(record, currentCardIndex);
}

function createWarehouseCard(record, index) {
    const isExpanded = warehouseData.expandedCards.has(record.dismissNumber);
    const isSaved = record.pdfUrl && record.pdfUrl.trim() !== '';
    
    // Use pre-resolved client names (Optimized)
    const clientNames = record.clientNames || '...';

    // Parse truck/driver/rep
    const parts = (record.truckDriverRep || '').split('-').map(p => p.trim());
    const truck = parts[0] || '';
    const driver = parts[1] || '';
    const deliveryRep = parts[2] || '';

    // Status badge logic
    let statusBadgeClass = 'warehouse-badge-pending';
    let statusBadgeIcon = '<i class="fas fa-clock"></i>';
    let statusBadgeText = 'Ù…Ø¹Ù„Ù‚';

    if (record.recordStatus === true) {
        statusBadgeClass = 'warehouse-badge-complete';
        statusBadgeIcon = '<i class="fas fa-check-circle"></i>';
        statusBadgeText = 'Ù…ÙƒØªÙ…Ù„';
    } else if (record.recordStatus === false) {
        statusBadgeClass = 'warehouse-badge-incomplete';
        statusBadgeIcon = '<i class="fas fa-times-circle"></i>';
        statusBadgeText = 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„';
    }
    
    // Save status badge
    let saveBadgeClass = 'warehouse-badge-draft';
    let saveBadgeText = '<i class="fas fa-edit"></i> Ù…Ø³ÙˆØ¯Ø©';
    let fileIcon = '';

    if (isSaved) {
        saveBadgeClass = 'warehouse-badge-saved';
        saveBadgeText = '<i class="fas fa-save"></i> Ù…Ø­ÙÙˆØ¸';
        fileIcon = `<a href="${record.pdfUrl}" target="_blank" class="warehouse-file-icon" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯">
            <i class="fa-solid fa-file-circle-check"></i>
        </a>`;
    }
    
    // Border color based on record status (Col J)
    let borderColor = '#fff3cd'; // Pending - yellow
    if (record.recordStatus === true) {
        borderColor = '#d4edda'; // Complete - green
    } else if (record.recordStatus === false) {
        borderColor = '#721c24'; // Incomplete - red
    }

    // Status icon color (Col B)
    let statusIconClass = 'fa-circle';
    let statusColor = '#6c757d';

    if (record.status === 'Prepare') {
        statusIconClass = 'fa-hourglass-half';
        statusColor = '#ffc107';
    } else if (record.status === 'Shipped') {
        statusIconClass = 'fa-truck';
        statusColor = '#17a2b8';
    } else if (record.status === 'Delivered') {
        statusIconClass = 'fa-check';
        statusColor = '#28a745';
    } else if (record.status === 'Paid') {
        statusIconClass = 'fa-hand-holding-usd';
        statusColor = '#007bff';
    }

    // --- NEW: Check Readiness for Petroleum Gradient ---
    const readyClass = isRecordReady(record) ? 'card-ready' : '';

    // Build HTML
    let html = `<div class="warehouse-card ${isExpanded ? 'warehouse-card-expanded' : 'warehouse-card-collapsed'} ${readyClass}" 
                    id="warehouse-card-${record.dismissNumber}" 
                    data-dismiss="${record.dismissNumber}"
                    data-index="${index}"
                    style="border-right: 5px solid ${borderColor};">`;
        
    // Card Header (Always Visible)
    html += `<div class="warehouse-card-header">`;
    
    // Status Icon
    html += `<div class="warehouse-card-status-icon" style="background-color: ${statusColor};">`;
    html += `<i class="fas ${statusIconClass}"></i>`;
    html += `</div>`;
    
    // Header Content
    html += `<div class="warehouse-card-header-content" onclick="toggleWarehouseCard('${record.dismissNumber}')">`;
    html += `<div class="warehouse-card-header-main">`;
    
    // Title Line
    html += `<div class="warehouse-card-title">`;
    html += `<span class="warehouse-dismiss-number"><i class="fas fa-clipboard-list"></i> Ø±Ù‚Ù… Ø§Ù„ØµØ±Ù: ${record.dismissNumber}</span>`;
    html += fileIcon;
    html += `</div>`;
    
    // Info Line
    html += `<div class="warehouse-card-info">`;
    html += `<span><i class="far fa-calendar-alt"></i> ${record.loadingDate}</span>`;
    html += `<span><i class="fas fa-truck"></i> ${truck}</span>`;
    html += `<span><i class="fas fa-user"></i> ${driver}</span>`;
    if (deliveryRep) {
        html += `<span><i class="fas fa-user-tie"></i> ${deliveryRep}</span>`;
    }
    html += `</div>`;
    
    // Clients Line
    html += `<div class="warehouse-card-clients">`;
    html += `<strong>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</strong> ${clientNames}`;
    html += `</div>`;
    html += `</div>`; // Close main
    
    // Badges
    html += `<div class="warehouse-card-badges">`;
    html += `<span class="warehouse-badge ${statusBadgeClass}">${statusBadgeIcon} ${statusBadgeText}</span>`;
    html += `<span class="warehouse-badge ${saveBadgeClass}">${saveBadgeText}</span>`;
    html += `</div>`;
    
    // Toggle Icon
    html += `<div class="warehouse-card-toggle">`;
    html += `<i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}"></i>`;
    html += `</div>`;
    
    html += `</div>`; // Close header content
    html += `</div>`; // Close header
    
    // Card Body (Expanded View)
    if (isExpanded) {
        html += `<div class="warehouse-card-body">`;
        html += createWarehouseCardBody(record, index);
        html += `</div>`;
    }
    
    html += `</div>`; // Close card
    
    return html;
}

function createWarehouseCardBody(record, cardIndex) {
    let html = '';
    
    // --- 1. Order Details Section ---
    html += `<div class="warehouse-section">`;
    html += `<h5>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h5>`;
    html += `<div class="warehouse-details-grid">`;
    html += `<div><strong>Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</strong> ${record.orderIds}</div>`;
    html += `<div><strong>ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong><br>${record.invoiceDates.replace(/\n/g, '<br>')}</div>`;
    html += `<div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${record.status}</div>`;
    
    // Show Expected Returns if available
    if (record.expectedReturns) {
        html += `<div><strong>Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…ØªÙˆÙ‚Ø¹Ø©:</strong> ${record.expectedReturns}</div>`;
    }
    
    html += `</div>`;
    html += `</div>`;

    // --- 2. Products Table Section ---
    html += `<div class="warehouse-section">`;
    html += `<h5>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>`;
    html += `<div class="warehouse-products-table-wrapper">`;
    html += `<table class="warehouse-products-table">`;
    html += `<thead><tr>`;
    html += `<th>Ø§Ù„Ù…Ù†ØªØ¬</th>`;
    html += `<th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>`;
    html += `<th>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th>`;
    html += `<th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­Ù…Ù„Ø©</th>`;
    html += `<th>Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø§Ù„ØªØ©</th>`;
    html += `<th>Ø§Ù„ÙƒÙ…ÙŠØ© Ù„ÙƒÙ„ Ø¨Ø§Ù„ØªØ©</th>`;
    html += `<th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</th>`;
    html += `<th>Ù…ØªØ§Ø­</th>`;
    html += `<th><i class="fas fa-check-circle"></i></th>`;
    html += `</tr></thead>`;
    html += `<tbody>`;

    // Loop through products
    record.products.forEach((product, pIndex) => {
        // Only show products that have ordered qty > 0 OR have been loaded
        if (product.orderedQty > 0 || (product.loadedQty && product.loadedQty > 0)) {
            const availableStock = calculateAvailableStock(product.name);
            
            // Calculate extra qty (frontend only display)
            const extraQty = product.loadedQty ? (product.loadedQty - product.orderedQty) : 0;
            const loadedQty = product.loadedQty !== undefined ? parseFloat(product.loadedQty) : 0;
            
            // Extract Pallet Info (ensure mapped to model properties if exists)
            // Note: handleWarehousePalletChange will update these properties in the model
            const pId = product.pallet_id !== undefined ? product.pallet_id : extractPalletId(product.pallets);
            const pQty = product.pallet_qty !== undefined ? product.pallet_qty : extractPalletQty(product.pallets);

            // Validation Visuals
            let validIcon = '';
            let inputClass = '';

            if (loadedQty > 0) {
                // User entered value - validate it
                const isValid = validateProductQty(loadedQty, product.orderedQty, availableStock);
                validIcon = isValid ?
                    '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>';
                inputClass = isValid ? 'warehouse-input-valid' : 'warehouse-input-invalid';
            } else {
                // No value yet
                if (product.orderedQty <= availableStock) {
                    validIcon = '<i class="fas fa-minus-circle text-secondary"></i>'; // Neutral
                } else {
                    validIcon = '<i class="fas fa-exclamation-circle text-warning"></i>'; // Warning
                }
            }
            
            // Available stock styling
            let availableClass = 'warehouse-stock-good';
            const balance = product.stockBalance || 1; 
            const availablePercent = (availableStock / balance) * 100;
            if (availableStock < 0) availableClass = 'warehouse-stock-low text-danger fw-bold';
            else if (availablePercent < 20) availableClass = 'warehouse-stock-low';
            else if (availablePercent < 50) availableClass = 'warehouse-stock-medium';
            
            html += `<tr>`;
            html += `<td class="warehouse-product-name">${product.name}</td>`;
            html += `<td>${product.stockBalance.toFixed(1)}</td>`;
            html += `<td>${product.orderedQty.toFixed(1)}</td>`;
            
            // QTY INPUT - Uses oninput for real-time validation
            html += `<td>
                <input type="number" 
                      class="warehouse-qty-input ${inputClass}" 
                      value="${loadedQty || ''}" 
                      placeholder="ÙƒÙ…ÙŠØ© ${product.orderedQty.toFixed(1)}"
                      step="0.01"
                      min="0"
                      data-product-index="${pIndex}"
                      oninput="handleWarehouseQtyChange(this, '${record.dismissNumber}', ${pIndex})"
                      ${record.pdfUrl ? 'disabled' : ''}>
            </td>`;
            
            // PALLET ID INPUT - Uses onchange to save to model
            html += `<td>
                <input type="text" 
                       class="warehouse-pallet-input" 
                       value="${pId}" 
                       placeholder="Ù…Ø¹Ø±Ù"
                       onchange="handleWarehousePalletChange(this, '${record.dismissNumber}', ${pIndex}, 'id')"
                       ${record.pdfUrl ? 'disabled' : ''}>
            </td>`;
            
            // PALLET QTY INPUT - Uses onchange to save to model
            html += `<td>
                <input type="text" 
                       class="warehouse-pallet-input" 
                       value="${pQty}" 
                       placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©"
                       onchange="handleWarehousePalletChange(this, '${record.dismissNumber}', ${pIndex}, 'qty')"
                       ${record.pdfUrl ? 'disabled' : ''}>
            </td>`;
            
            html += `<td>${extraQty.toFixed(1)}</td>`;
            html += `<td class="${availableClass}">${availableStock.toFixed(1)}</td>`;
            html += `<td>${validIcon}</td>`;
            html += `</tr>`;
        }
    });
    
    html += `</tbody></table>`;
    html += `</div>`; // End table wrapper
    html += `</div>`; // End products section
    
    // --- 3. Labor & Comments Section ---
    html += `<div class="warehouse-section">`;
    html += `<h5>Ø§Ù„Ø¹Ù…Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>`;
    html += `<div class="warehouse-labor-grid">`;
    
    // Pass record.dismissNumber (ID) instead of cardIndex
    html += `<div class="warehouse-labor-field">`;
    html += `<label>Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</label>`;
    html += createLaborMultiSelect('loading', record.loadingLabor, record.dismissNumber);
    html += `</div>`;

    html += `<div class="warehouse-labor-field">`;
    html += `<label>Ø¹Ù…Ø§Ù„ Ø§Ù„ØªÙØ±ÙŠØº</label>`;
    html += createLaborMultiSelect('unloading', record.unloadingLabor, record.dismissNumber);
    html += `</div>`;
    
    html += `</div>`; // End labor grid
    
    // Comments Input - UPDATED to use onchange handler with ID
    html += `<div class="warehouse-comments-field">`;
    html += `<label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>`;
    html += `<textarea class="warehouse-comments-textarea" 
                       placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."
                       onchange="handleWarehouseCommentChange(this, '${record.dismissNumber}')">${record.comments || ''}</textarea>`;
    html += `</div>`;
    html += `</div>`; // End section
    
    // --- 4. Action Buttons ---
    html += `<div class="warehouse-actions">`;
    const canSave = validateCard(record);
    
    if (!record.pdfUrl) {
        // Draft - Show Save & Print
        html += `<button class="warehouse-btn-save" 
                         onclick="saveWarehouseCard('${record.dismissNumber}')" 
                         ${canSave ? '' : 'disabled'}>
            <i class="fas fa-save"></i> Ø­ÙØ¸ Ùˆ Ø§ØµØ¯Ø§Ø±
        </button>`;
    } else {
        // Saved - Show Update & View
        html += `<button class="warehouse-btn-update" 
                         onclick="updateWarehouseCard('${record.dismissNumber}', ${cardIndex})"
                         ${canSave ? '' : 'disabled'}>
            <i class="fas fa-pen"></i> ØªØ­Ø¯ÙŠØ«
        </button>`;
        html += `<button class="warehouse-btn-view" 
                        onclick="viewAndPrintDocument('${record.dismissNumber}')">
            <i class="fa-solid fa-print"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        </button>`;
    }
    
    html += `</div>`; // End actions
    
    // Collapse Button
    html += `<div class="warehouse-collapse-btn" onclick="toggleWarehouseCard('${record.dismissNumber}')">`;
    html += `<i class="fas fa-chevron-up"></i> Ø·ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©`;
    html += `</div>`;

    return html;
}

/**
 * View document button handler - fetches fresh data and prints
 */
function viewAndPrintDocument(dismissNumber) {
    showWarehouseLoading(true);
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯...', 'info');
    
    google.script.run
        .withSuccessHandler(result => {
            showWarehouseLoading(false);
            if (result.success) {
                openSingleDocumentPrint(dismissNumber, result.data);
            } else {
                showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯: ' + result.message, 'error');
            }
        })
        .withFailureHandler(error => {
            showWarehouseLoading(false);
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯', 'error');
            console.error(error);
        })
        .getReleaseNoteDeepData(dismissNumber);
}

// =============================================================================
// STATS & BATCH OPERATIONS
// =============================================================================

function updateWarehouseStats() {
    const records = warehouseData.filteredRecords || [];
    
    // Categorize
    const saved = [];
    const draft = [];
    const ready = [];
    
    records.forEach(r => {
        if (r.pdfUrl && r.pdfUrl.trim() !== '') {
            saved.push(r.dismissNumber);
        } else {
            draft.push(r.dismissNumber);
            // Check if ready (valid inputs & stock)
            if (validateCard(r)) {
                ready.push(r.dismissNumber);
            }
        }
    });
    
    // Update Counts
    document.getElementById('stat-count-total').textContent = records.length;
    document.getElementById('stat-count-saved').textContent = saved.length;
    document.getElementById('stat-count-draft').textContent = draft.length;
    document.getElementById('stat-count-ready').textContent = ready.length;
    
    // Update Tooltips
    updateStatTooltip('tooltip-total', records.map(r => r.dismissNumber));
    updateStatTooltip('tooltip-saved', saved);
    updateStatTooltip('tooltip-draft', draft);
    updateStatTooltip('tooltip-ready', ready);
    
    // Update Batch Buttons State
    const btnSaveAll = document.getElementById('btn-batch-save');
    const btnPrintAll = document.getElementById('btn-batch-print');
    
    // CHANGE: Enable Save All ONLY if there is at least one READY record
    if (btnSaveAll) {
        btnSaveAll.disabled = (ready.length === 0);
        // Optional: Visual cue if ready > 0
        btnSaveAll.style.opacity = ready.length > 0 ? '1' : '0.6';
    }
    
    if (btnPrintAll) btnPrintAll.disabled = (saved.length === 0);
}

function updateStatTooltip(elementId, numbers) {
    const el = document.getElementById(elementId);
    if (!el) return;
    
    if (numbers.length === 0) {
        el.innerHTML = '<span style="opacity:0.6">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>';
    } else {
        // Create scrollable list
        el.innerHTML = numbers.join('<br>');
    }
}


function handleBatchSaveAll() {
    const records = warehouseData.filteredRecords || [];
    // FIX: Use local date helper
    const today = getLocalTodayDate();
    
    // 1. Identify Drafts
    const drafts = records.filter(r => !r.pdfUrl || r.pdfUrl.trim() === '');
    
    if (drafts.length === 0) return;
    
    // 2. Categorize Drafts
    const readyToSave = [];      // Valid Data + Today
    const skippedDateMismatch = []; // Valid Data + Wrong Date
    const skippedInvalidData = [];  // Invalid Data (Negative Stock/Missing Qty)
    
    drafts.forEach(r => {
        const isValid = validateCard(r); // Checks Qty >= Ordered and Stock >= 0
        
        if (!isValid) {
            skippedInvalidData.push(r.dismissNumber);
        } else {
            // Check Date Constraint
            if (r.loadingDate === today) {
                readyToSave.push(r);
            } else {
                skippedDateMismatch.push(r.dismissNumber);
            }
        }
    });
    
    // 3. Logic Flow
    if (readyToSave.length === 0) {
        let msg = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­ÙØ¸.';
        if (skippedDateMismatch.length > 0) {
            msg += `\n\nâš ï¸ ØªÙ… ØªØ®Ø·ÙŠ ${skippedDateMismatch.length} Ø³Ø¬Ù„ Ù„Ø£Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ÙŠÙˆÙ… (${today}).\n(Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø­ÙØ¸ Ø³Ø¬Ù„Ø§Øª Ø¨ØªÙˆØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©)`;
        } else if (skippedInvalidData.length > 0) {
            msg += '\n\nâš ï¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ø±ØµÙŠØ¯).';
        }
        showCustomConfirm('ØªÙ†Ø¨ÙŠÙ‡', msg, false);
        return;
    }
    
    if (skippedDateMismatch.length > 0 || skippedInvalidData.length > 0) {
        let warningMsg = `Ø³ÙŠØªÙ… Ø­ÙØ¸ ${readyToSave.length} Ø³Ø¬Ù„ Ø¬Ø§Ù‡Ø².\n\nâš ï¸ ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:`;
        
        if (skippedDateMismatch.length > 0) {
            warningMsg += `\n\nğŸ›‘ Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡Ùˆ Ø§Ù„ÙŠÙˆÙ… ${today}):\n[ ${skippedDateMismatch.join(', ')} ]`;
        }
        
        if (skippedInvalidData.length > 0) {
            warningMsg += `\n\nğŸ›‘ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©:\n[ ${skippedInvalidData.join(', ')} ]`;
        }
        
        warningMsg += `\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ù…ØªØ§Ø¨Ø¹Ø© Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© (${readyToSave.length}) ÙÙ‚Ø·ØŸ`;
        
        showCustomConfirm(
            'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ',
            warningMsg,
            true,
            () => executeBatchSave(readyToSave)
        );
    } else {
        executeBatchSave(readyToSave);
    }
}

function executeBatchSave(recordsToSave) {
    const saveBtn = document.getElementById('btn-batch-save');
    let originalHtml = '';

    if(saveBtn) {
        originalHtml = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    }

    // Step 1: Save text data (batch optimized)
    const batchData = recordsToSave.map(r => {
        const index = warehouseData.filteredRecords.indexOf(r);
        return collectWarehouseRecordData(r, index);
    });
    
    showToast(`Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ ${recordsToSave.length} Ø³Ø¬Ù„...`, 'info');
    
    google.script.run
        .withSuccessHandler(results => {
            // Step 2: Generate PNGs sequentially with progress
            const needsPrint = results.filter(r => r.success && r.needsPrint);
            
            if (needsPrint.length > 0) {
                generateBatchPNGs(needsPrint, 0, saveBtn, originalHtml);
            } else {
                finalizeBatchSave(results, saveBtn, originalHtml);
            }
        })
        .withFailureHandler(error => {
            if(saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalHtml;
            }
            handleWarehouseError(error);
        })
        .batchSaveWarehouseReleaseNotes(batchData);
}

async function generateBatchPNGs(records, currentIndex, saveBtn, originalHtml) {
    if (currentIndex >= records.length) {
        finalizeBatchSave(records, saveBtn, originalHtml);
        return;
    }

    const record = records[currentIndex];
    const progress = currentIndex + 1;
    const total = records.length;
    
    if (saveBtn) {
        saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø´Ø§Ø¡ ${progress}/${total}...`;
    }
    
    showToast(`Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ${progress}/${total}...`, 'info');

    google.script.run
        .withSuccessHandler(async result => {
            if (result.success) {
                try {
                    // Create HTML document
                    const htmlContent = await createStandaloneHtml(record.dismissNumber, result.data);
                    
                    // Save to Drive
                    saveHtmlDocument(record.dismissNumber, htmlContent, (saveResult) => {
                        if (saveResult.success) {
                            // Store URL in BOTH places for tracking
                            record.pdfUrl = saveResult.url;
                            record.success = true;
                        } else {
                            record.printError = true;
                            record.success = false;
                        }
                        // Move to next
                        generateBatchPNGs(records, currentIndex + 1, saveBtn, originalHtml);
                    });
                    
                } catch (e) {
                    console.error('Batch HTML error:', e);
                    record.printError = true;
                    generateBatchPNGs(records, currentIndex + 1, saveBtn, originalHtml);
                }
            } else {
                record.printError = true;
                generateBatchPNGs(records, currentIndex + 1, saveBtn, originalHtml);
            }
        })
        .withFailureHandler(error => {
            record.printError = true;
            generateBatchPNGs(records, currentIndex + 1, saveBtn, originalHtml);
        })
        .getReleaseNoteDeepData(record.dismissNumber);
}

function finalizeBatchSave(results, saveBtn, originalHtml) {
    if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalHtml;
    }
    
    let successCount = results.filter(r => r.success && r.pdfUrl).length;
    let printErrors = results.filter(r => r.printError).length;
    
    // CRITICAL: Update local model with actual URLs from results
    results.forEach(res => {
        if (res.success && res.pdfUrl) {
            const rec = warehouseData.filteredRecords.find(r => r.dismissNumber == res.dismissNumber);
            if (rec) {
                rec.pdfUrl = res.pdfUrl; // Use actual URL from save result
            }
        }
    });
    
    let message = `ØªÙ… Ø­ÙØ¸ ${successCount} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`;
    if (printErrors > 0) {
        message += ` (${printErrors} ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)`;
    }
    
    showToast(message, successCount > 0 ? 'success' : 'error');
    renderWarehouseCards(); // Re-render to show clickable links
    updateWarehouseStats();
    
    // AUTO-PRINT: Trigger Print All after successful batch save
    if (successCount > 0) {
        setTimeout(() => {
            showCustomConfirm(
                'Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©',
                `ØªÙ… Ø­ÙØ¸ ${successCount} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¢Ù†ØŸ`,
                true,
                () => handleBatchPrintAll()
            );
        }, 500);
    }
}

function handleBatchPrintAll() {
    const records = warehouseData.filteredRecords || [];
    const saved = records.filter(r => r.pdfUrl && r.pdfUrl.trim() !== '');
    
    if (saved.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'warning');
        return;
    }
    
    showToast(`Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± ${saved.length} Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©...`, 'info');
    showWarehouseLoading(true);
    
    // Fetch all release data
    const fetchPromises = saved.map(r => {
        return new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        resolve({ dismissNumber: r.dismissNumber, data: result.data });
                    } else {
                        resolve(null);
                    }
                })
                .withFailureHandler(() => resolve(null))
                .getReleaseNoteDeepData(r.dismissNumber);
        });
    });
    
    Promise.all(fetchPromises).then(results => {
        const validResults = results.filter(r => r !== null);
        
        if (validResults.length === 0) {
            showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            showWarehouseLoading(false);
            return;
        }
        
        // Generate multi-page HTML
        generateMultiPagePrintout(validResults);
    });
}

async function generateMultiPagePrintout(dataArray) {
    try {
        let allPagesHtml = '';
        
        // Generate HTML for each record
        for (let i = 0; i < dataArray.length; i++) {
            const { dismissNumber, data } = dataArray[i];
            
            // Render individual page
            renderModernReleaseHtml(data);
            generateLocalQRCodes();
            
            // Wait for QR codes
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const container = document.getElementById('print-generator-container');
            if (container) {
                let pageHtml = container.innerHTML;
                
                // Replace Font Awesome with SVG
                pageHtml = replaceFontAwesomeWithSVG(pageHtml);
                
                // Wrap in page container with page break
                allPagesHtml += `
                <div class="print-page" style="page-break-after: always;">
                    ${pageHtml}
                </div>
                `;
            }
        }
        
        // Create complete multi-page document
        const multiPageDoc = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø°Ù† ØµØ±Ù - Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© (${dataArray.length} Ù…Ø³ØªÙ†Ø¯)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
        }
        
        /* Print Guide Banner */
        .print-guide {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999999;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .print-guide-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin: 0 10px;
            vertical-align: middle;
        }
        
        .print-page {
            position: relative;
        }
        
        /* Remove page break for last page */
        .print-page:last-child {
            page-break-after: auto !important;
        }
        
        @media print {
            .print-guide { display: none !important; }
            body { margin: 0; }
            @page { 
                margin: 0; 
                size: A4 portrait; 
            }
            .print-page {
                page-break-after: always;
            }
            .print-page:last-child {
                page-break-after: auto;
            }
        }
        
        @media screen {
            body { 
                background: #f5f5f5; 
                padding-top: 70px;
            }
            .print-page {
                background: white;
                margin: 20px auto;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                max-width: 210mm;
            }
        }
    </style>
</head>
<body>
    <!-- Print Guide Banner -->
    <div class="print-guide">
        <svg class="print-guide-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
        <span class="print-guide-text">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©: ${dataArray.length} Ù…Ø³ØªÙ†Ø¯ | Ø§Ø¶ØºØ· Ctrl+P (Ø£Ùˆ âŒ˜+P Ø¹Ù„Ù‰ Mac)</span>
        <svg class="print-guide-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
    </div>
    
    <!-- All Pages -->
    ${allPagesHtml}
</body>
</html>`;
        
    // Open in new window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(multiPageDoc);
        printWindow.document.close();
        
        // Wait for fonts/images to load, then auto-scale and print
        printWindow.onload = function() {
            setTimeout(() => {
                // Auto-scale pages that exceed A4 height
                autoScalePages(printWindow);
                
                // Trigger print dialog
                setTimeout(() => {
                    printWindow.print();
                }, 300);
            }, 500);
        };
        
        showWarehouseLoading(false);
        showToast(`ØªÙ… ØªØ­Ø¶ÙŠØ± ${dataArray.length} Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©`, 'success');
        
    } catch (e) {
        console.error('Multi-page generation error:', e);
        showToast('ÙØ´Ù„ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª', 'error');
        showWarehouseLoading(false);
    }
}


/**
 * Auto-scales pages that exceed A4 height to fit on single page
 */
function autoScalePages(printWindow) {
    try {
        const pages = printWindow.document.querySelectorAll('.print-page');
        const maxHeightMM = 297; // A4 height in mm
        
        pages.forEach((page, index) => {
            // Get the actual bounding rect which includes all content
            const rect = page.getBoundingClientRect();
            const pageHeightPx = rect.height;
            
            // Convert to mm (assuming 96 DPI: 1mm = 3.7795px)
            const pageHeightMM = pageHeightPx / 3.7795;
            
            console.log(`Page ${index + 1}: Height = ${pageHeightMM.toFixed(1)}mm (${pageHeightPx.toFixed(0)}px)`);
            
            // Only scale if page exceeds A4 height
            if (pageHeightMM > maxHeightMM) {
                // Calculate scale factor with 2% safety margin
                const scaleFactor = (maxHeightMM * 0.98) / pageHeightMM;
                
                // Apply transform to the page content wrapper
                const contentWrapper = page.querySelector('.modern-print-wrapper');
                if (contentWrapper) {
                    contentWrapper.style.transform = `scale(${scaleFactor})`;
                    contentWrapper.style.transformOrigin = 'top center';
                    
                    // Adjust page container to fit scaled content
                    const scaledHeightPx = pageHeightPx * scaleFactor;
                    page.style.height = `${scaledHeightPx}px`;
                    page.style.overflow = 'hidden';
                    
                    console.log(`Page ${index + 1}: SCALED to ${(scaleFactor * 100).toFixed(1)}% (${pageHeightMM.toFixed(1)}mm â†’ ${(pageHeightMM * scaleFactor).toFixed(1)}mm)`);
                } else {
                    console.warn(`Page ${index + 1}: Content wrapper not found`);
                }
            } else {
                console.log(`Page ${index + 1}: No scaling needed`);
            }
        });
        
    } catch (e) {
        console.error('Auto-scale error:', e);
        // Don't block printing if scaling fails
    }
}

function createLaborMultiSelect(type, selected, dismissNumber) { // Changed arg from cardIndex to dismissNumber
    const id = `warehouse-labor-${type}-${dismissNumber}`;
    const selectedArray = Array.isArray(selected) ? selected : [];
    
    let html = `<div class="warehouse-labor-checkbox-container" id="${id}">`;
    warehouseData.laborList.forEach((labor, index) => {
        const isChecked = selectedArray.includes(labor);
        const checkboxId = `${id}-${index}`;
        
        html += `<label class="warehouse-labor-checkbox-label">`;
        html += `<input type="checkbox" class="warehouse-labor-checkbox" value="${labor}" ${isChecked ? 'checked' : ''} id="${checkboxId}"
                  onchange="handleWarehouseLaborChange(this, '${dismissNumber}', '${type}')">`;
        html += `<span class="warehouse-labor-checkbox-text">${labor}</span>`;
        html += `</label>`;
    });
    html += `</div>`;
    return html;
}

// =============================================================================
// CARD INTERACTIONS
// =============================================================================

function toggleWarehouseCard(dismissNumber) {
    if (warehouseData.expandedCards.has(dismissNumber)) {
        warehouseData.expandedCards.delete(dismissNumber);
    } else {
        warehouseData.expandedCards.add(dismissNumber);
    }
    
    renderWarehouseCards();
}

function validateCardInputs(cardIndex) {
    const record = warehouseData.filteredRecords[cardIndex];
    if (!record) return;

    // USE ID SELECTOR to find the specific card DOM element
    const cardElement = document.getElementById(`warehouse-card-${record.dismissNumber}`);
    if (!cardElement) return;

    record.products.forEach((product, pIndex) => {
        if (product.orderedQty > 0) {
            const available = calculateAvailableStock(product.name);
            const loaded = parseFloat(product.loadedQty) || 0;
            const ordered = parseFloat(product.orderedQty);
            
            // Logic: Valid if (Loaded >= Ordered) AND (Available >= 0)
            const isValid = (loaded >= ordered) && (available >= 0);
            
            // Scoped Query Selector (scoped to this card element)
            const input = cardElement.querySelector(`input[data-product-index="${pIndex}"].warehouse-qty-input`);
            if (input) {
                input.classList.toggle('warehouse-input-valid', isValid);
                input.classList.toggle('warehouse-input-invalid', !isValid);
            }
            
            // Update validation icon
            let rowIndex = 1;
            for (let i = 0; i <= pIndex; i++) {
                if (record.products[i].orderedQty > 0) {
                    if (i === pIndex) {
                        const icon = cardElement.querySelector(`table tbody tr:nth-child(${rowIndex}) td:nth-child(9)`);
                        if (icon) {
                            if (product.loadedQty && product.loadedQty > 0) {
                                icon.innerHTML = isValid ? 
                                    '<i class="fas fa-check-circle text-success"></i>' : 
                                    '<i class="fas fa-times-circle text-danger"></i>';
                            } else {
                                // No value yet
                                if (product.orderedQty <= available) {
                                    icon.innerHTML = '<i class="fas fa-minus-circle text-secondary"></i>';
                                } else {
                                    icon.innerHTML = '<i class="fas fa-exclamation-circle text-warning"></i>';
                                }
                            }
                        }
                        break;
                    }
                    rowIndex++;
                }
            }
        }
    });
}

// =============================================================================
// VALIDATION
// =============================================================================

function calculateAvailableStock(productName) {
    // Find product in master list
    const masterProduct = warehouseData.masterProducts.find(p => p.name === productName);
    if (!masterProduct) return 0;
    
    let totalUsed = 0;
    
    // Sum all loaded qty in ALL UNSAVED filtered cards
    for (let i = 0; i < warehouseData.filteredRecords.length; i++) {
        const record = warehouseData.filteredRecords[i];
        
        // Skip saved cards (already reflected in Row 6)
        if (record.pdfUrl && record.pdfUrl.trim() !== '') {
            continue;
        }
        
        const product = record.products.find(p => p.name === productName);
        if (product && product.loadedQty) {
            totalUsed += product.loadedQty;
        }
    }
    
    return masterProduct.stockBalance - totalUsed;
}

function validateProductQty(loadedQty, orderedQty, availableStock) {
    const loaded = parseFloat(loadedQty);
    const ordered = parseFloat(orderedQty);
    const available = parseFloat(availableStock);
    
    if (!loaded || loaded === 0) return false;
    
    // Must be >= ordered
    if (loaded < ordered) return false;
    
    // Available stock must remain positive (not checking loaded <= available)
    // Since available is cumulative, just check it's not negative
    if (available < 0) return false;
    
    return true;
}

// =============================================================================
// VALIDATION & SAVE LOGIC
// =============================================================================

/**
 * Checks if a card is ready to be saved.
 * Prerequisites:
 * 1. For every product with Ordered Qty > 0: Loaded Qty >= Ordered Qty
 * 2. Cumulative Available Stock >= 0 (Cannot over-issue stock)
 * 3. Input values are valid numbers
 */
function validateCard(record) {
    // Iterate through all products in this record
    for (let product of record.products) {
        // Skip products that weren't ordered
        if (product.orderedQty <= 0) continue;

        const loaded = parseFloat(product.loadedQty) || 0;
        const ordered = parseFloat(product.orderedQty);
        
        // Rule 1: Must fulfill the order
        if (loaded < ordered) return false;

        // Rule 2: Check global stock availability
        // We recalculate availability for this specific item
        const available = calculateAvailableStock(product.name);
        
        // Note: available < 0 is allowed ONLY IF the current loaded qty causes it
        // but typically we want the final state to be non-negative.
        if (available < 0) return false;
    }
    
    return true;
}

function updateCardSaveButton(record, cardIndex) {
    const cardElement = document.getElementById(`warehouse-card-${record.dismissNumber}`);
    if (!cardElement) return;

    // Check Logic
    const isValid = validateCard(record);
    const isReady = isRecordReady(record); // Checks Date + Draft + Valid

    // 1. Update Buttons
    const saveBtn = cardElement.querySelector('.warehouse-btn-save');
    const updateBtn = cardElement.querySelector('.warehouse-btn-update');

    if (saveBtn) saveBtn.disabled = !isValid;
    if (updateBtn) updateBtn.disabled = !isValid;

    // 2. Update Visual Style (Real-time Petroleum Tinge)
    if (isReady) {
        cardElement.classList.add('card-ready');
    } else {
        cardElement.classList.remove('card-ready');
    }
}

function updateAvailableStockDisplay() {
    // Iterate all expanded cards to update their "Available" column
    // We use ID-based selectors to avoid collisions with other modules
    warehouseData.filteredRecords.forEach((record, idx) => {
        // Only update if card is visible/expanded
        if (warehouseData.expandedCards.has(record.dismissNumber)) {
            
            const cardElement = document.getElementById(`warehouse-card-${record.dismissNumber}`);
            if (!cardElement) return;

            let rowIndex = 1; // Start at 1 (skip header)
            record.products.forEach((product) => {
                if (product.orderedQty > 0) {
                    const available = calculateAvailableStock(product.name);
                    
                    // Target the specific cell (8th column)
                    const cell = cardElement.querySelector(`table tbody tr:nth-child(${rowIndex}) td:nth-child(8)`);
                    if (cell) {
                        cell.textContent = available.toFixed(1);
                        
                        // Visual Feedback
                        cell.className = '';
                        // Avoid division by zero
                        const balance = product.stockBalance || 1; 
                        const percent = (available / balance) * 100;
                        
                        if (available < 0) cell.classList.add('warehouse-stock-low', 'text-danger', 'fw-bold');
                        else if (percent < 20) cell.classList.add('warehouse-stock-low');
                        else if (percent < 50) cell.classList.add('warehouse-stock-medium');
                        else cell.classList.add('warehouse-stock-good');
                    }
                    rowIndex++;
                }
            });
            
            // Also re-check the save button since stock changed
            updateCardSaveButton(record, idx);
        }
    });
}

// =============================================================================
// SAVE / UPDATE
// =============================================================================

// =============================================================================
// SAVE / UPDATE WITH LOADING STATE
// =============================================================================

function saveWarehouseCard(dismissNumber) { 
    // 1. Find record
    const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
    if (!record) return;

    // --- DATE VALIDATION ---
    const today = getLocalTodayDate();
    if (record.loadingDate !== today) {
        showCustomConfirm(
            'ØªÙ†Ø¨ÙŠÙ‡ - Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„ØªØ§Ø±ÙŠØ®',
            `Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„.\n\nØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„: ${record.loadingDate}\nØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…: ${today}\n\nÙ„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠØŒ ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø­ÙØ¸ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ·Ø§Ø¨Ù‚ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ….`,
            false 
        );
        return; 
    }

    // --- INPUT VALIDATION ---
    if (!validateCard(record)) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ§Øª ØµØ­ÙŠØ­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø±ØµÙŠØ¯', 'error');
        return;
    }
    
    // 2. Set Button Loading State
    const cardElement = document.getElementById(`warehouse-card-${dismissNumber}`);
    const btn = cardElement ? cardElement.querySelector('.warehouse-btn-save') : null;
    let originalHtml = ''; // Declare outside
    
    if (btn) {
        originalHtml = btn.innerHTML; // Capture value
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        btn.style.opacity = '0.7';
    }
    
    const recordData = collectWarehouseRecordData(record);
    
    // 3. Call Backend (Save Data)
    google.script.run
        .withSuccessHandler(function(result) {
            if (!result.success) {
                // Restore button on logic failure
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    btn.style.opacity = '1';
                }
                showToast(result.message, 'error');
                return;
            }

            // 4. Success -> Generate Image
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø¬Ø§Ø±ÙŠ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©...', 'success');
            // Keep button loading while generating image
            generateAndPrintReleaseNote(dismissNumber); 
        })
        .withFailureHandler(function(error) {
            // Restore button on network failure
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                btn.style.opacity = '1';
            }
            handleWarehouseError(error);
        })
        .saveWarehouseReleaseNote(recordData);
}

/**
 * Checks if a record is visually "Ready"
 * Criteria: Unsaved (Draft) + Today's Date + Valid Inputs
 */
function isRecordReady(record) {
    // FIX: Use local date helper
    const today = getLocalTodayDate();
    const isDraft = !record.pdfUrl || record.pdfUrl.trim() === '';
    const isToday = record.loadingDate === today;
    
    return isDraft && isToday && validateCard(record);
}

function updateWarehouseCard(dismissNumber, cardIndex) {
    // 1. Find record safely
    const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
    if (!record) return;

    const realIndex = warehouseData.filteredRecords.indexOf(record);

    // 2. Validate
    if (!validateCard(record)) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ§Øª ØµØ­ÙŠØ­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'error');
        return;
    }
    
    // 3. Set Button Loading State
    const cardElement = document.getElementById(`warehouse-card-${dismissNumber}`);
    const btn = cardElement ? cardElement.querySelector('.warehouse-btn-update') : null;
    let originalHtml = '';
    
    if (btn) {
        originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...'; // Updating...
        btn.style.opacity = '0.7';
    }
    
    // 4. Collect Data
    const recordData = collectWarehouseRecordData(record, realIndex);
    
    // 5. Call Backend
    google.script.run
        .withSuccessHandler(function(result) {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                btn.style.opacity = '1';
            }
            handleWarehouseSaveSuccess(result, realIndex);
        })
        .withFailureHandler(function(error) {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                btn.style.opacity = '1';
            }
            handleWarehouseError(error);
        })
        .updateWarehouseReleaseNote(recordData);
}

function collectWarehouseRecordData(record) { // Removed cardIndex arg, not needed
    // 1. Prepare Products Array from MODEL
    const products = [];
    
    record.products.forEach((product) => {
        // Only include relevant products
        if (product.orderedQty > 0 || (product.loadedQty && product.loadedQty > 0)) {
            products.push({
                columnOffset: product.columnOffset,
                name: product.name,
                loadedQty: parseFloat(product.loadedQty) || 0,
                // Use the model's pallet string which is updated by handlers
                pallets: product.pallets || '', 
                orderedQty: product.orderedQty,
                extraQty: (parseFloat(product.loadedQty) || 0) - product.orderedQty
            });
        }
    });
    
    // 2. Get User Email
    const userEmail = localStorage.getItem('userEmail') || '';

    // 3. Return Clean Data Object
    // We use the record's properties directly because they are now always up to date
    return {
        dismissNumber: record.dismissNumber,
        rowIndex: record.rowIndex,
        orderIds: record.orderIds,
        loadingDate: record.loadingDate,
        truckDriverRep: record.truckDriverRep,
        products: products,
        loadingLabor: record.loadingLabor || [],
        unloadingLabor: record.unloadingLabor || [],
        comments: record.comments || '',
        userEmail: userEmail
    };
}

function handleWarehouseSaveSuccess(result, cardIndex) {
    if (!result.success) {
        showToast(result.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error');
        return;
    }
    
    showToast(result.message || 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    
    // Update record with PDF URL
    warehouseData.filteredRecords[cardIndex].pdfUrl = result.pdfUrl;
    
    // Re-render card
    renderWarehouseCards();
}

// =============================================================================
// HELPER FUNCTIONS
// =============================================================================

function extractPalletId(palletsStr) {
    if (!palletsStr) return '';
    const parts = palletsStr.split('-');
    return parts[0] ? parts[0].trim() : '';
}

function extractPalletQty(palletsStr) {
    if (!palletsStr) return '';
    const parts = palletsStr.split('-');
    return parts[1] ? parts[1].trim() : '';
}

function showWarehouseLoading(show) {
    const loading = document.getElementById('warehouse-loading');
    const container = document.getElementById('warehouse-cards-container');
    
    if (loading) {
        loading.style.display = show ? 'flex' : 'none';
    }
    if (container) {
        container.style.display = show ? 'none' : 'block';
    }
}

function batchPrintWarehouse() {
    // TODO: Implement batch printing
    showToast('Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
}

// Toggle Filter Bar
function toggleFilterBar() {
    const panel = document.getElementById('warehouse-filter-panel');
    const icon = document.getElementById('filter-toggle-icon');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        panel.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Date Presets Logic
function setDatePreset(preset) {
    const startInput = document.getElementById('warehouse-filter-date-start');
    const endInput = document.getElementById('warehouse-filter-date-end');
    const today = new Date();
    
    let start = null;
    let end = null;

    if (preset === 'today') {
        start = end = today;
    } else if (preset === 'yesterday') {
        const y = new Date(today); y.setDate(y.getDate() - 1);
        start = end = y;
    } else if (preset === 'last7') {
        end = today;
        start = new Date(today); start.setDate(start.getDate() - 7);
    } else if (preset === 'thisMonth') {
        start = new Date(today.getFullYear(), today.getMonth(), 1);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    } else if (preset === 'lastMonth') {
        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        end = new Date(today.getFullYear(), today.getMonth(), 0);
    } else if (preset === 'all') {
        start = '';
        end = '';
    }

    if (start instanceof Date) start = start.toISOString().split('T')[0];
    if (end instanceof Date) end = end.toISOString().split('T')[0];

    if (start !== null) startInput.value = start;
    if (end !== null) endInput.value = end;
}

function handleWarehouseCommentChange(input, dismissNumber) {
    const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
    if (record) {
        record.comments = input.value;
    }
}

function handleWarehouseLaborChange(checkbox, dismissNumber, type) {
    const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
    if (!record) return;

    const val = checkbox.value;
    // Initialize if undefined
    if (type === 'loading') {
        if (!record.loadingLabor) record.loadingLabor = [];
        
        if (checkbox.checked) {
            if (!record.loadingLabor.includes(val)) record.loadingLabor.push(val);
        } else {
            record.loadingLabor = record.loadingLabor.filter(l => l !== val);
        }
    } else {
        if (!record.unloadingLabor) record.unloadingLabor = [];
        
        if (checkbox.checked) {
            if (!record.unloadingLabor.includes(val)) record.unloadingLabor.push(val);
        } else {
            record.unloadingLabor = record.unloadingLabor.filter(l => l !== val);
        }
    }
}

function handleWarehousePalletChange(input, dismissNumber, productIndex, field) {
    const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
    if (record && record.products[productIndex]) {
        // field is 'id' or 'qty'
        record.products[productIndex][`pallet_${field}`] = input.value;
        
        // Construct standard string for backend compatibility
        const pId = record.products[productIndex].pallet_id || '';
        const pQty = record.products[productIndex].pallet_qty || '';
        record.products[productIndex].pallets = pId || pQty ? `${pId} - ${pQty}` : '';
    }
}

// =============================================================================
// MODERN PRINT GENERATION (PNG)
// =============================================================================

function generateAndPrintReleaseNote(dismissNumber) {
    showWarehouseLoading(true);
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...', 'info');
    
    google.script.run
        .withSuccessHandler(async result => {
            if (!result.success) {
                showToast(result.message, 'error');
                showWarehouseLoading(false);
                return;
            }
            
            try {
                // Create standalone HTML document
                showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯...', 'info');
                const htmlContent = await createStandaloneHtml(dismissNumber, result.data);
                
                // Save to Drive
                saveHtmlDocument(dismissNumber, htmlContent, (saveResult) => {
                    showWarehouseLoading(false);
                    if (saveResult.success) {
                        renderWarehouseCards(); // Refresh to show saved status
                        
                        // Auto-open print window for this document
                        setTimeout(() => {
                            openSingleDocumentPrint(dismissNumber, result.data);
                        }, 500);
                    }
                });
                
            } catch (e) {
                console.error('HTML generation error:', e);
                showToast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯', 'error');
                showWarehouseLoading(false);
            }
        })
        .withFailureHandler(error => {
            handleWarehouseError(error);
            showWarehouseLoading(false);
        })
        .getReleaseNoteDeepData(dismissNumber);
}

/**
 * Opens print window for a single document (same as batch but for one)
 */
async function openSingleDocumentPrint(dismissNumber, data) {
    try {
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...', 'info');
        
        // Render document
        renderModernReleaseHtml(data);
        generateLocalQRCodes();
        
        // Wait for QR codes
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const container = document.getElementById('print-generator-container');
        if (!container) {
            showToast('ÙØ´Ù„ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
            return;
        }
        
        let pageHtml = container.innerHTML;
        
        // Replace Font Awesome with SVG
        pageHtml = replaceFontAwesomeWithSVG(pageHtml);
        
        // Create single-page print document (same structure as batch)
        const printDoc = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø°Ù† ØµØ±Ù Ù…Ù†ØªØ¬ ØªØ§Ù… #${dismissNumber}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
        }
        
        /* Print Guide Banner */
        .print-guide {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999999;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .print-guide-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin: 0 10px;
            vertical-align: middle;
        }
        
        .print-page {
            position: relative;
        }
        
        @media print {
            .print-guide { display: none !important; }
            body { margin: 0; }
            @page { 
                margin: 0; 
                size: A4 portrait; 
            }
        }
        
        @media screen {
            body { 
                background: #f5f5f5; 
                padding-top: 70px;
            }
            .print-page {
                background: white;
                margin: 20px auto;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                max-width: 210mm;
            }
        }
    </style>
</head>
<body>
    <!-- Print Guide Banner -->
    <div class="print-guide">
        <svg class="print-guide-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
        <span class="print-guide-text">Ø§Ø¶ØºØ· Ctrl+P Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø£Ùˆ âŒ˜+P Ø¹Ù„Ù‰ Mac)</span>
        <svg class="print-guide-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
    </div>
    
    <!-- Document Page -->
    <div class="print-page">
        ${pageHtml}
    </div>
</body>
</html>`;
        
        // Open in new window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printDoc);
        printWindow.document.close();
        
        // Wait for load, auto-scale, then print
        printWindow.onload = function() {
            setTimeout(() => {
                // Auto-scale if needed
                autoScalePages(printWindow);
                
                // Trigger print dialog
                setTimeout(() => {
                    printWindow.print();
                }, 300);
            }, 500);
        };
        
        showToast('ØªÙ… ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
        
    } catch (e) {
        console.error('Print error:', e);
        showToast('ÙØ´Ù„ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
    }
}

// NEW HELPER FUNCTION
function generateLocalQRCodes() {
    const containers = document.querySelectorAll('.local-qr-placeholder');
    containers.forEach(container => {
        const url = container.dataset.url;
        if (url) {
            container.innerHTML = '';
            
            // 1. Generate at High Resolution (110px)
            // The CSS (.mp-card-qr) will shrink this visually if needed
            new QRCode(container, {
                text: url,
                width: 110,
                height: 110,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });

            // 2. Force the library's generated image to be responsive
            // This ensures it respects the flex-shrink we defined in styleFix
            setTimeout(() => {
                const img = container.querySelector('img');
                if (img) {
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                }
            }, 10);
        }
    });
}

// =============================================================================
// STANDALONE HTML DOCUMENT GENERATION
// =============================================================================

/**
 * Creates self-contained HTML document with embedded QR codes
 */
async function createStandaloneHtml(dismissNumber, data) {
    return new Promise((resolve, reject) => {
        try {
            // 1. Render the content
            renderModernReleaseHtml(data);
            
            // 2. Generate QR codes
            generateLocalQRCodes();
            
            // 3. Wait for QR codes to render
            setTimeout(() => {
                const container = document.getElementById('print-generator-container');
                if (!container) {
                    reject(new Error('Container not found'));
                    return;
                }
                
                // 4. Get all content including generated QR codes
                let contentHtml = container.innerHTML;
                
                // 5. Replace Font Awesome icons with inline SVG
                contentHtml = replaceFontAwesomeWithSVG(contentHtml);
                
                // 6. Create standalone HTML document with print guide
                const fullHtml = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø°Ù† ØµØ±Ù Ù…Ù†ØªØ¬ ØªØ§Ù… #${dismissNumber}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
        }
        
        /* Print Guide Banner */
        .print-guide {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999999;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        
        .print-guide-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin: 0 10px;
            vertical-align: middle;
        }
        
        .print-guide-text {
            display: inline-block;
            vertical-align: middle;
        }
        
        .content-wrapper {
            margin-top: 70px;
        }
        
        @media print {
            .print-guide { display: none !important; }
            .content-wrapper { margin-top: 0 !important; }
            body { margin: 0; }
            @page { margin: 0; size: A4 portrait; }
        }
        
        @media screen {
            body { 
                background: #f5f5f5; 
            }
            .content-wrapper {
                padding: 20px;
                display: flex;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Print Guide Banner -->
    <div class="print-guide">
        <svg class="print-guide-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
        <span class="print-guide-text">Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDFØŒ Ø§Ø¶ØºØ· Ctrl+P (Ø£Ùˆ âŒ˜+P Ø¹Ù„Ù‰ Mac)</span>
        <svg class="print-guide-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
    </div>
    
    <!-- Main Content -->
    <div class="content-wrapper">
        ${contentHtml}
    </div>
</body>
</html>`;
                
                resolve(fullHtml);
            }, 1500);
            
        } catch (e) {
            reject(e);
        }
    });
}

/**
 * Replaces Font Awesome icons with inline SVG
 */
function replaceFontAwesomeWithSVG(html) {
    const iconMap = {
        'fa-truck': '<svg viewBox="0 0 640 512" fill="currentColor"><path d="M48 0C21.5 0 0 21.5 0 48V368c0 26.5 21.5 48 48 48H64c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H48zM416 160h50.7L544 237.3V256H416V160zM112 416a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm368-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/></svg>',
        'fa-user': '<svg viewBox="0 0 448 512" fill="currentColor"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3 0 498.7 13.3 512 29.7 512h388.6c16.4 0 29.7-13.3 29.7-29.7 0-98.5-79.8-178.3-178.3-178.3h-91.4z"/></svg>',
        'fa-user-tie': '<svg viewBox="0 0 448 512" fill="currentColor"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm95.8 32.6L272 480l-32-136 32-56h-96l32 56-32 136-47.8-191.4C56.9 302 0 374.5 0 482.3 0 498.7 13.3 512 29.7 512h388.6c16.4 0 29.7-13.3 29.7-29.7 0-107.8-56.9-180.3-128.2-193.7z"/></svg>',
        'fa-dolly': '<svg viewBox="0 0 576 512" fill="currentColor"><path d="M0 32C0 14.3 14.3 0 32 0h72.9c27.5 0 52 17.6 60.7 43.8L257.7 320c30.1 .5 56.8 14.9 74 37l202.1-67.4c16.8-5.6 34.9 3.5 40.5 20.2s-3.5 34.9-20.2 40.5L352 417.7c-.9 52.2-43.5 94.3-96 94.3-53 0-96-43-96-96 0-30.8 14.5-58.2 37-76L104.9 64H32C14.3 64 0 49.7 0 32zM244.8 134.5c-5.5-16.8 3.7-34.9 20.5-40.3L355.1 64.3c16.8-5.5 34.9 3.7 40.3 20.5l49.4 152.2c5.5 16.8-3.7 34.9-20.5 40.3L334.5 307.2c-16.8 5.5-34.9-3.7-40.3-20.5L244.8 134.5z"/></svg>',
        'fa-box-open': '<svg viewBox="0 0 640 512" fill="currentColor"><path d="M58.9 42.1c3-6.1 9.6-9.6 16.3-8.7L320 64 564.8 33.4c6.7-.8 13.3 2.7 16.3 8.7l41.7 83.4c9 17.9-.6 39.6-19.8 45.1L439.6 217.3c-13.9 4-28.8-1.9-36.2-14.3L320 64 236.6 203c-7.4 12.4-22.3 18.3-36.2 14.3L37.1 170.6c-19.3-5.5-28.8-27.2-19.8-45.1L58.9 42.1zM321.1 128l54.9 91.4c14.9 24.8 44.6 36.6 72.5 28.6L576 211.6v167c0 22-15 41.2-36.4 46.6l-204.1 51c-10.2 2.6-20.9 2.6-31 0l-204.1-51C79 419.7 64 400.5 64 378.5v-167L191.6 248c27.8 8 57.6-3.8 72.5-28.6L318.9 128h2.2z"/></svg>',
        'fa-money-bill-wave': '<svg viewBox="0 0 576 512" fill="currentColor"><path d="M0 112.5V422.3c0 18 10.1 35 27 41.3 87 32.5 174 10.3 261-11.9 79.8-20.3 159.6-40.7 239.3-18.9 23 6.3 48.7-9.5 48.7-33.4V89.7c0-18-10.1-35-27-41.3C462 15.9 375 38.1 288 60.3 208.2 80.6 128.4 100.9 48.7 79.1 25.6 72.8 0 88.6 0 112.5zM288 352c-44.2 0-80-43-80-96s35.8-96 80-96 80 43 80 96-35.8 96-80 96zM64 352c35.3 0 64 28.7 64 64H64V352zm64-208c0 35.3-28.7 64-64 64V144h64zM512 304v64h-64c0-35.3 28.7-64 64-64zM448 96h64v64c-35.3 0-64-28.7-64-64z"/></svg>',
        'fa-clock': '<svg viewBox="0 0 512 512" fill="currentColor"><path d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>',
        'fa-map-marker-alt': '<svg viewBox="0 0 384 512" fill="currentColor"><path d="M215.7 499.2C267 435 384 279.4 384 192 384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2 12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/></svg>',
        'fa-phone': '<svg viewBox="0 0 512 512" fill="currentColor"><path d="M164.9 24.6c-7.7-18.6-28-28.5-47.4-23.2l-88 24C12.1 30.2 0 46 0 64C0 311.4 200.6 512 448 512c18 0 33.8-12.1 38.6-29.5l24-88c5.3-19.4-4.6-39.7-23.2-47.4l-96-40c-16.3-6.8-35.2-2.1-46.3 11.6L304.7 368C234.3 334.7 177.3 277.7 144 207.3L193.3 167c13.7-11.2 18.4-30 11.6-46.3l-40-96z"/></svg>',
        'fa-location-arrow': '<svg viewBox="0 0 448 512" fill="currentColor"><path d="M429.6 92.1c4.9-11.9 2.1-25.6-7-34.7s-22.8-11.9-34.7-7l-352 144c-14.2 5.8-22.2 20.8-19.3 35.8s16.1 25.8 31.4 25.8H224V432c0 15.3 10.8 28.4 25.8 31.4s30-5.1 35.8-19.3l144-352z"/></svg>',
        'fa-map': '<svg viewBox="0 0 576 512" fill="currentColor"><path d="M384 476.1L192 421.2V35.9L384 90.8V476.1zm32-1.2V88.4L543.1 37.5c15.8-6.3 32.9 5.3 32.9 22.3V394.6c0 9.8-6 18.6-15.1 22.3L416 474.8zM15.1 95.1L160 37.2V423.6L32.9 474.5C17.1 480.8 0 469.2 0 452.2V117.4c0-9.8 6-18.6 15.1-22.3z"/></svg>',
        'fa-map-marked-alt': '<svg viewBox="0 0 576 512" fill="currentColor"><path d="M408 120c0 54.6-73.1 151.9-105.2 192c-7.7 9.6-22 9.6-29.6 0C241.1 271.9 168 174.6 168 120C168 53.7 221.7 0 288 0s120 53.7 120 120zm8 80.4c3.5-6.9 6.7-13.8 9.6-20.6c.5-1.2 1-2.5 1.5-3.7l116-46.4C558.9 123.4 576 135 576 152V422.8c0 9.8-6 18.6-15.1 22.3L416 503V200.4zM137.6 138.3c2.4 14.1 7.2 28.3 12.8 41.5c2.9 6.8 6.1 13.7 9.6 20.6V451.8L32.9 502.7C17.1 509 0 497.4 0 480.4V209.6c0-9.8 6-18.6 15.1-22.3l122.6-49zM327.8 332c13.9-17.4 35.7-45.7 56.2-77V504.3L192 449.4V255c20.5 31.3 42.3 59.6 56.2 77c20.5 25.6 59.1 25.6 79.6 0zM288 152a40 40 0 1 0 0-80 40 40 0 1 0 0 80z"/></svg>',
        'fa-comment-dots': '<svg viewBox="0 0 512 512" fill="currentColor"><path d="M256 448c141.4 0 256-93.1 256-208S397.4 32 256 32 0 125.1 0 240c0 45.1 17.7 86.8 47.7 120.9-1.9 24.5-11.4 46.3-21.4 62.9-5.5 9.2-11.1 16.6-15.2 21.6-2.1 2.5-3.7 4.4-4.9 5.7-.6.6-1 1.1-1.3 1.4l-.3.3 0 0 0 0 0 0 0 0c-4.6 4.6-5.9 11.4-3.4 17.4s8.3 9.9 14.8 9.9c28.7 0 57.6-8.9 81.6-19.3 22.9-10 42.4-21.9 54.3-30.6 31.8 11.5 67 17.9 104.1 17.9zM128 208a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm128 0a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm96 32a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/></svg>',
        'fa-pen': '<svg viewBox="0 0 512 512" fill="currentColor"><path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7.8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg>'
    };
    
    // Replace each icon
    for (const [faClass, svgCode] of Object.entries(iconMap)) {
        const regex = new RegExp(`<i[^>]*class="[^"]*${faClass}[^"]*"[^>]*><\\/i>`, 'g');
        html = html.replace(regex, `<span style="display:inline-block;width:1em;height:1em;vertical-align:-0.125em;">${svgCode}</span>`);
    }
    
    return html;
}

/**
 * Saves HTML document to Google Drive
 */
function saveHtmlDocument(dismissNumber, htmlContent, callback) {
    showToast('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯...', 'info');
    
    google.script.run
        .withSuccessHandler(result => {
            if (result.success) {
                // Update local record
                const record = warehouseData.filteredRecords.find(r => r.dismissNumber.toString() === dismissNumber.toString());
                if (record) {
                    record.pdfUrl = result.url;
                }
                
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                if (callback) callback(result);
            } else {
                showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯: ' + result.message, 'error');
                if (callback) callback(result);
            }
        })
        .withFailureHandler(error => {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯', 'error');
            console.error(error);
            if (callback) callback({ success: false, message: error.toString() });
        })
        .saveHtmlDocument(dismissNumber, htmlContent);
}
function renderModernReleaseHtml(data) {
    var r = data.release;
    var clients = data.clients;

    // --- 1. DATA PREPARATION ---
    var dismissStr = String(r.dismissNumber || '');
    var loadingOrderNum = dismissStr.length >= 2 ? dismissStr.slice(-2) : '00';

    var dateObj = new Date(r.loadingDate);
    var dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    var dateStr = dateObj.toLocaleDateString('ar-EG', dateOptions);

    // Logistics Logic
    var truckParts = r.truckDriver ? r.truckDriver.split('-') : [];
    var truck = truckParts[0] ? truckParts[0].trim() : null;
    var driver = truckParts[1] ? truckParts[1].trim() : null;
    var rep = truckParts[2] ? truckParts[2].trim() : null;

    var qrCollection = [];
    var internalCommentsCollection = [];
    var productStats = {};

    // Calculate product count early for dynamic styling
    var productCount = 0;

    // --- 2. CSS STYLES ---
    var styleBlock = '<style>' +
        '@import url("https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Tajawal:wght@400;500;700;800&display=swap");' +
        
        '.modern-print-wrapper { padding: 10mm; font-family: "Tajawal", sans-serif; direction: rtl; color: #000; background: #fff; width: 210mm; min-height: 297mm; box-sizing: border-box; position: relative; -webkit-print-color-adjust: exact; }' +
        '.landscape { width: 297mm; min-height: 210mm; }' +
        
        /* HEADER */
        '.mp-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #000; padding-bottom: 12px; margin-bottom: 15px; }' +
        '.mp-header-right { display: flex; align-items: center; gap: 20px; }' +
        '.mp-loading-circle { width: 55px; height: 55px; border-radius: 50%; background: #fff; color: #000; border: 4px solid #000; display: flex; justify-content: center; align-items: center; font-size: 28px; font-family: "Oswald", sans-serif; font-weight: 700; box-shadow: 2px 2px 0px rgba(0,0,0,0.2); }' +
        '.mp-date-group { display: flex; flex-direction: column; justify-content: center; }' +
        '.mp-date-day { font-size: 16px; font-weight: 800; color: #000; margin-bottom: 4px; }' +
        '.mp-meta { display: flex; gap: 12px; font-size: 13px; font-weight: 600; color: #333; }' +
        
        /* HEADER LEFT - Fixed Distortion */
        '.mp-header-left { text-align: left; }' +
        '.mp-header-left h1 { margin: 0; font-size: 24px; font-weight: 900; color: #000; }' + /* Removed text-transform/letter-spacing */
        '.mp-badge { background: #fff; color: #000; border: 2px solid #999; padding: 4px 12px; border-radius: 6px; font-weight: 800; font-size: 18px; display: inline-block; margin-top: 6px; font-family: "Oswald", sans-serif; letter-spacing: 1px; }' +

        /* LABOR STRIP */
        '.mp-labor-strip { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 8px 15px; border: 1px solid #000; border-radius: 4px; margin-bottom: 20px; font-size: 13px; font-weight: 700; box-shadow: 3px 3px 0 #eee; }' +
        '.mp-labor-item { display: flex; align-items: center; gap: 8px; }' +

        /* CLIENT CARD */
        '.mp-client-card { border: 2px solid #000; border-radius: 6px; margin-bottom: 8px; overflow: hidden; page-break-inside: avoid; background: #fff; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }' +
        '.mp-card-header { background: #f4f4f4; padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #000; min-height: 28px; }' +
        '.mp-client-name { font-weight: 900; font-size: 13px; color: #000; display: flex; align-items: center; gap: 8px; }' +
        '.mp-dist-badge.specific { background: #e0e0e0; color: #000; font-weight: 600; border: 1px solid #000; border-radius: 25px; font-size: 10px; padding: 1px 12px 1px 12px;}' +
        '.mp-dist-badge.region { background: #f0f0f0; color: #666; font-weight: 600; border: 1px solid #ccc; border-radius: 25px; font-size: 10px; padding: 1px 12px 1px 12px;}' +
        '.mp-region-label { font-size: 11px; color: #666; font-weight: 600; margin-right: 5px; }' +
        
        /* 20/80 Split Layout */
        '.mp-card-body { display: flex; width: 100%; }' +
        
        /* LEFT (Contact) - 20% WRAPPING ENABLED */
        '.mp-card-contact { width: 20%; padding: 4px 6px; font-size: 10px; border-left: 1px solid #000; display: flex; flex-direction: column; justify-content: center; gap: 2px; background: #fafafa; }' +
        '.mp-contact-row { display: flex; align-items: flex-start; gap: 4px; color: #000; white-space: normal; line-height: 1.2; }' + /* Enabled wrapping */
        '.mp-contact-row i { margin-top: 2px; flex-shrink: 0; }' +
        
        /* RIGHT (Products) - 80% FLEXIBLE */
        '.mp-card-products { width: 80%; padding: 4px; display: flex; flex-wrap: wrap; gap: 4px; align-content: center; }' +
        '.mp-prod-col { display: flex; flex-direction: column; border: 1px solid #999; border-radius: 4px; min-width: fit-content; text-align: center; overflow: hidden; flex: 1 0 auto; max-width: 100%; }' + /* Auto-width */
        '.mp-prod-name { background: #e0e0e0; font-size: 9px; padding: 2px 4px; font-weight: 800; color: #000; white-space: normal; line-height: 1.1; border-bottom: 1px solid #999; }' + /* Wrapping enabled */
        '.mp-prod-qty { font-size: 13px; font-weight: 900; padding: 2px; color: #000; font-family: "Oswald"; }' +
        '.mp-prod-return { font-size: 9px; background: #fff; color: #000; padding: 1px; border-top: 1px dashed #000; font-weight: 700; }' +

        /* SUMMARY TABLES */
        '.mp-table-container { margin-top: 15px; page-break-inside: avoid; }' +
        '.mp-table-row { display: flex; border-bottom: 1px solid #000; }' +
        '.mp-table-row:last-child { border-bottom: none; }' +
        '.mp-cell { flex: 1; padding: 5px; text-align: center; border-left: 1px solid #000; font-size: 11px; display: flex; align-items: center; justify-content: center; min-width: 0; }' +
        '.mp-cell:last-child { border-left: none; }' +

        /* Product Headers - Simple Horizontal with Wrap */
        '.mp-cell.prod-head { font-weight: 800; background: #f4f4f4; font-size: 9px; padding: 5px; }' +
        '.mp-cell.prod-head span { white-space: normal; word-wrap: break-word; line-height: 1.2; display: block; }' +

        '.mp-cell.label { flex: 0 0 110px; font-weight: 800; background: #e0e0e0; justify-content: flex-end; padding-right: 8px; }' +
        '.mp-table-top { border: 2px solid #000; border-radius: 8px 8px 0 0; overflow: hidden; margin-bottom: 15px; }' +
        '.mp-cell.loaded { font-weight: 900; font-size: 13px; font-family: "Oswald"; }' +
        '.mp-table-bottom { border: 2px solid #000; border-radius: 0 0 8px 8px; overflow: hidden; border-top: 2px dashed #000; }' +
        '.mp-cell.extra { font-weight: 700; }' + 
        '.mp-cell.extra-val { font-family: "Oswald"; font-weight: bold; }' +

        /* COMMENTS */
        '.mp-comments-section { margin-top: 15px; border: 2px solid #000; padding: 8px; border-radius: 6px; font-size: 11px; page-break-inside: avoid; background: #fff; display: block; }' +
        '.mp-comments-header { font-weight: 900; color: #000; margin-bottom: 4px; display: block; text-decoration: underline; }' +
        '.mp-int-comment-row { margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px dotted #ccc; display: block; }' +
        
        /* QR CONTAINER - Justified Space Between */
        '.mp-qr-container { margin-top: 20px; border: 2px solid #000; padding: 20px 15px 10px 15px; border-radius: 12px; position: relative; page-break-inside: avoid; }' +
        '.mp-qr-floating-icon { position: absolute; top: -18px; right: 20px; background: white; padding: 0 10px; font-size: 32px; color: #000; z-index: 1; }' +
        '.mp-qr-grid { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; padding-top: 5px; }' +
        '.mp-qr-item { text-align: center; flex: 0 1 auto; }' +
        '.mp-qr-client { font-size: 10px; font-weight: 800; margin-bottom: 4px; margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; border-bottom: 1px solid #ccc; padding-bottom: 2px; max-width: 150px; }' +
        
        /* QR Size */
        '.local-qr-placeholder { margin: 0 auto; }' + 
        '.mp-card-qr { width: 105px !important; height: auto; }' +
        '.mp-card-qr img { width: 100% !important; height: auto !important; }' +

        /* FOOTER */
        '.mp-footer { margin-top: 25px; border-top: 2px solid #000; padding-top: 5px; display: flex; justify-content: space-between; font-size: 10px; font-weight: 600; color: #000;}' +
        '</style>';

    // --- 3. BUILD CONTENT ---
    var html = '<div class="modern-print-wrapper">' + styleBlock;

    // HEADER
    html += '<div class="mp-header">';
    html +=   '<div class="mp-header-right">';
    html +=     '<div class="mp-loading-circle">' + parseInt(loadingOrderNum) + '</div>';
    html +=     '<div class="mp-date-group">';
    html +=       '<div class="mp-date-day">' + dateStr + '</div>';
    html +=       '<div class="mp-meta">';
    if(truck) html += '<span><i class="fas fa-truck"></i> ' + truck + '</span>';
    if(truck && driver) html += '<span>|</span>';
    if(driver) html += '<span><i class="fas fa-user"></i> ' + driver + '</span>';
    // Strict Rep Check
    if((truck||driver) && rep && rep !== '-') {
        html += '<span>|</span>';
        html += '<span><i class="fas fa-user-tie"></i> ' + rep + '</span>';
    }
    html +=       '</div>';
    html +=     '</div>';
    html +=   '</div>';
    html +=   '<div class="mp-header-left">';
    html +=     '<h1>Ø¥Ø°Ù† ØµØ±Ù Ù…Ù†ØªØ¬ ØªØ§Ù…</h1>';
    html +=     '<div class="mp-badge">#' + r.dismissNumber + '</div>';
    html +=   '</div>';
    html += '</div>';

    // LABOR STRIP
    if ((r.loadingLabor && r.loadingLabor !== '') || (r.unloadingLabor && r.unloadingLabor !== '')) {
        html += '<div class="mp-labor-strip">';
        var loadTxt = r.loadingLabor || '-';
        var unloadTxt = r.unloadingLabor || '-';
        html += '<div class="mp-labor-item"><i class="fas fa-dolly"></i> <strong>ØªØ­Ù…ÙŠÙ„:</strong> ' + loadTxt + '</div>';
        html += '<div class="mp-labor-item"><i class="fas fa-box-open"></i> <strong>ØªÙ†Ø²ÙŠÙ„:</strong> ' + unloadTxt + '</div>';
        html += '</div>';
    }

    // CLIENT CARDS
    if (clients && clients.length > 0) {
        clients.forEach(function(c) {
            
            // Collect Data
            if (c.locationUrl) {
                qrCollection.push({ name: c.name || 'Client', url: c.locationUrl });
            }
            if (c.internalComments) {
                internalCommentsCollection.push({ client: c.name, text: c.internalComments });
            }

            // Aggregate Products
            if (c.products) {
                Object.keys(c.products).forEach(function(prod) {
                    var qty = parseFloat(c.products[prod]) || 0;
                    if (!productStats[prod]) productStats[prod] = { ordered: 0, loaded: 0 };
                    productStats[prod].ordered += qty;
                });
            }

            // CARD
            html += '<div class="mp-client-card">';
            
            // Header
            html +=   '<div class="mp-card-header">';
            html +=     '<div class="mp-client-name">';

            // Distance Display Logic
            if (c.distance && c.distance > 0) {
                if (c.distanceType === 'specific') {
                    html += '<span class="mp-dist-badge specific"><i class="fas fa-location-arrow"></i> ' + c.distance + ' km</span>';
                } else if (c.distanceType === 'region') {
                    html += '<span class="mp-dist-badge region"><i class="fas fa-map"></i> ' + c.distance + ' km</span>';
                }
            }

            // Client Name with Region
            html += '<span>' + (c.name || 'Unknown');
            if (c.region) {
                html += ' <span class="mp-region-label">(' + c.region + ')</span>';
            }
            html += '</span>';

            html +=     '</div>';
            html +=     '<div class="mp-card-meta">';
            if (c.paymentPlan) {
                var icon = c.paymentPlan.indexOf('Ù†Ù‚Ø¯ÙŠ') > -1 ? 'fa-money-bill-wave' : 'fa-clock';
                html += '<span><i class="fas '+icon+'"></i> ' + c.paymentPlan + '</span>';
            }
            html +=     '</div>';
            html +=   '</div>';

            // Body
            html +=   '<div class="mp-card-body">';
            
            // Contact (20%)
            var contactHtml = '';
            if (c.address) contactHtml += '<div class="mp-contact-row"><i class="fas fa-map-marker-alt"></i> ' + c.address + '</div>';
            if (c.phone) contactHtml += '<div class="mp-contact-row"><i class="fas fa-phone"></i> ' + c.phone + '</div>';
            if (c.personInCharge) contactHtml += '<div class="mp-contact-row"><i class="fas fa-user"></i> ' + c.personInCharge + '</div>';
            
            if (contactHtml) {
                html += '<div class="mp-card-contact">' + contactHtml + '</div>';
            } else {
                html += '<div class="mp-card-contact" style="border:none; background:none;"></div>';
            }

            // Products (80%)
            html +=     '<div class="mp-card-products">';
            if (c.products) {
                Object.keys(c.products).forEach(function(pName) {
                    var ordQty = c.products[pName];
                    var retQty = 0; // Placeholder
                    
                    html += '<div class="mp-prod-col">';
                    html +=   '<div class="mp-prod-name" title="'+pName+'">' + pName + '</div>';
                    html +=   '<div class="mp-prod-qty">' + ordQty + '</div>';
                    if (retQty > 0) html += '<div class="mp-prod-return">' + retQty + '</div>';
                    html += '</div>';
                });
            }
            html +=     '</div>'; 
            html +=   '</div>'; // End Body
            html += '</div>'; // End Card
        });
    }

    // Map Loaded Qty
    if (r.totalLoadedMap) {
        Object.keys(r.totalLoadedMap).forEach(function(prod) {
            var qty = r.totalLoadedMap[prod];
            if (!productStats[prod]) productStats[prod] = { ordered: 0, loaded: 0 };
            productStats[prod].loaded = qty;
        });
    }

    // --- SUMMARY TABLES ---
    var productsList = Object.keys(productStats);
    if (productsList.length > 0) {
        html += '<div class="mp-table-container">';
        
        // TABLE 1
        html += '<div class="mp-table-top">';
        html += '<div class="mp-table-row"><div class="mp-cell label">Ø§Ù„Ø¨ÙŠØ§Ù†</div>';
        productsList.forEach(function(p) { 
            html += '<div class="mp-cell prod-head"><span>' + p + '</span></div>'; 
        });
        html += '</div>';

        html += '<div class="mp-table-row"><div class="mp-cell label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>';
        productsList.forEach(function(p) { 
            html += '<div class="mp-cell">' + productStats[p].ordered + '</div>'; 
        });
        html += '</div>';

        html += '<div class="mp-table-row"><div class="mp-cell label">ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ (ÙØ¹Ù„ÙŠ)</div>';
        productsList.forEach(function(p) { 
            html += '<div class="mp-cell loaded">' + (productStats[p].loaded || 0) + '</div>'; 
        });
        html += '</div>';
        html += '</div>';

        // TABLE 2
        var hasExtra = false;
        var extraRowHtml = '<div class="mp-table-row"><div class="mp-cell label">Ø²ÙŠØ§Ø¯Ø©</div>';
        
        productsList.forEach(function(p) {
            var extra = (productStats[p].loaded || 0) - productStats[p].ordered;
            var val = extra > 0 ? '+' + extra : (extra === 0 ? '-' : extra);
            if (extra !== 0) hasExtra = true;
            extraRowHtml += '<div class="mp-cell extra-val">' + val + '</div>';
        });
        extraRowHtml += '</div>';

        var returnRowHtml = '<div class="mp-table-row"><div class="mp-cell label">Ù…Ø±ØªØ¬Ø¹ Ù…ØªÙˆÙ‚Ø¹</div>';
        productsList.forEach(function(p) {
            var extra = (productStats[p].loaded || 0) - productStats[p].ordered;
            var val = extra > 0 ? extra : '-';
            returnRowHtml += '<div class="mp-cell extra-val">' + val + '</div>';
        });
        returnRowHtml += '</div>';

        html += '<div class="mp-table-bottom">';
        html += extraRowHtml;
        html += returnRowHtml;
        html += '</div>'; 
        html += '</div>';
        }

    // --- COMMENTS ---
    // Internal Comments
    if (internalCommentsCollection.length > 0) {
        html += '<div class="mp-comments-section">';
        html += '<span class="mp-comments-header"><i class="fas fa-comment-dots"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© (Ø·Ù„Ø¨Ø§Øª):</span>';
        internalCommentsCollection.forEach(function(item) {
            html += '<div class="mp-int-comment-row"><strong>' + item.client + ':</strong> ' + item.text + '</div>';
        });
        html += '</div>';
    }

    // Stockkeeper Comments
    if (r.comments && r.comments.trim() !== '') {
        html += '<div class="mp-comments-section" style="border: 2px solid #000;">';
        html += '<span class="mp-comments-header"><i class="fas fa-pen"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø®Ø²Ù†:</span>';
        html += '<div>' + r.comments + '</div>';
        html += '</div>';
    }

    // --- QR CODES ---
    if (qrCollection.length > 0) {
        html += '<div class="mp-qr-container">';
        html +=   '<div class="mp-qr-floating-icon"><i class="fas fa-map-marked-alt"></i></div>';
        html +=   '<div class="mp-qr-grid">';
        
        qrCollection.forEach(function(qr) {
            html += '<div class="mp-qr-item">';
            html +=   '<span class="mp-qr-client" title="'+qr.name+'">' + qr.name + '</span>';
            // Placeholder for Library (Dynamic 105px)
            html +=   '<div class="local-qr-placeholder" data-url="' + qr.url + '"></div>';
            html += '</div>';
        });

        html +=   '</div>';
        html += '</div>';
    }

    // FOOTER
    var timestamp = new Date().toLocaleString('ar-EG');
    var user = localStorage.getItem('userEmail') || 'System';
    html += '<div class="mp-footer">';
    html +=   '<div>Ø·Ø¨Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø©: ' + user + '</div>';
    html +=   '<div>' + timestamp + '</div>';
    html += '</div>';

    html += '</div>';

    // Inject
    var container = document.getElementById('print-generator-container');
    if(!container) {
        container = document.createElement('div');
        container.id = 'print-generator-container';
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '-9999px';
        container.style.zIndex = '99999';
        document.body.appendChild(container);
    }
    
    // Auto Landscape
    var isLandscape = productsList.length > 8;
    container.style.width = isLandscape ? '297mm' : '210mm';
    container.style.minHeight = isLandscape ? '210mm' : '297mm';
    
    container.innerHTML = html;
    
    // QR CSS Fix
    var qrFix = '<style>' +
        '.mp-qr-item { flex: 0 1 auto; display: flex; flex-direction: column; align-items: center; }' +
        '.local-qr-placeholder { width: 105px !important; height: 105px !important; }' +
        '.local-qr-placeholder img { width: 100% !important; height: auto !important; }' +
        '</style>';
    container.innerHTML += qrFix;
}

function snapAndSaveReleaseNote(dismissNumber, callback) {
    const element = document.getElementById('print-generator-container');
    
    html2canvas(element, {
        scale: 2, // High resolution
        useCORS: true, // Allow Google Charts QR
        logging: false
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png').split(',')[1];
        
        // Remove temp container
        document.body.removeChild(element);
        
        // Upload
        showToast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'info');
        google.script.run
            .withSuccessHandler(res => {
                if (res.success) {
                    showToast('ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ø°Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    // Update local record URL
                    const rec = warehouseData.filteredRecords.find(r => r.dismissNumber == dismissNumber);
                    if (rec) rec.pdfUrl = res.url;
                    renderWarehouseCards();
                    // Call callback if provided (for batch operations)
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                } else {
                    showToast('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + res.message, 'error');
                }
                showWarehouseLoading(false);
            })
            .withFailureHandler(err => {
                showToast('Ø®Ø·Ø£: ' + err, 'error');
                showWarehouseLoading(false);
            })
            .saveReleaseNoteImage(dismissNumber, imgData);
    });
}
// =============================================================================
// END OF WAREHOUSE MODULE
// =============================================================================
</script>
