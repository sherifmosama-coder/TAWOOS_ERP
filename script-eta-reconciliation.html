<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap');

  :root {
    /* --- COLOR PALETTE --- */
    --petroleum-dark: #264653;
    --petroleum-light: #2a9d8f;
    --blue-dark: #1d3557;
    --gray-text: #455a64;
    --border-color: #e0e0e0;
    
    /* --- GRADIENTS (Icons Only) --- */
    --grad-success: linear-gradient(145deg, #2e7d32, #388e3c); 
    --grad-warning: linear-gradient(145deg, #ef6c00, #f57c00);
    --grad-danger:  linear-gradient(145deg, #c62828, #d32f2f);
    --grad-petrol:  linear-gradient(145deg, #264653, #2c5161);
    
    --shadow-card: 0 2px 8px rgba(0,0,0,0.06);
    --radius: 10px;
  }

  body { font-family: 'Poppins', sans-serif; background-color: #eceff1; }

  /* --- CONTAINER --- */
  .eta-dashboard-container {
    padding: 20px;
    background-color: #eceff1;
    min-height: 85vh;
  }

  /* --- CARD STYLES --- */
  .eta-table-card {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow-card);
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .eta-header-card {
    background: white;
    padding: 15px 20px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: var(--shadow-card);
    border-left: 5px solid var(--petroleum-dark);
  }
  
  .eta-title {
    font-size: 1.1rem; font-weight: 600; color: var(--petroleum-dark);
    display: flex; align-items: center; gap: 10px;
  }

  /* --- TABLE HEADER --- */
  .reconcile-table { width: 100%; border-collapse: separate; border-spacing: 0; }
  
  .reconcile-table thead th {
    background: var(--petroleum-dark);
    color: white;
    font-weight: 500;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 15px;
    position: sticky; top: 0; z-index: 10;
  }

  /* --- ROW GROUPS --- */
  .reconcile-group {
    border-bottom: 1px solid #cfd8dc;
  }
  .reconcile-group:hover {
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-1px);
    z-index: 5; position: relative;
    transition: all 0.2s ease;
  }

  /* --- CELLS --- */
  .cell-common {
    vertical-align: middle;
    border-right: 1px solid #eceff1;
    background: white; 
  }

  /* --- DATA CHIPS (New Styling) --- */
  .data-chip {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 16px; /* Pill Shape */
    font-size: 0.85rem;
    font-weight: 600;
    white-space: nowrap;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .data-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }

  /* Serial Chip */
  .chip-serial {
    background: #e3f2fd; color: #1565c0; border-color: #bbdefb;
    font-family: 'Consolas', monospace; font-size: 0.95rem;
  }
  
  /* Date Chip */
  .chip-date {
    background: #f5f5f5; color: #546e7a; border-color: #eceff1;
    font-size: 0.8rem;
  }

  /* Money Chip */
  .chip-money {
    background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;
    font-family: 'Consolas', monospace;
  }
  .chip-money-err {
    background: #ffebee; color: #c62828; border-color: #ffcdd2;
  }
  .chip-money-dark {
     background: #eceff1; color: var(--blue-dark); border-color: #cfd8dc;
  }


  /* Order Summary (Reduced Width) */
  .col-summary-rtl {
    direction: rtl; text-align: right;
    font-family: 'Cairo', sans-serif;
    font-size: 0.85rem; line-height: 1.5;
    color: var(--gray-text);
    white-space: pre-line;
    max-width: 180px; /* Reduced from ~250px */
  }

  /* --- ROW COLORING --- */
  .row-internal td {
    padding: 10px 12px;
    border-top: 1px solid #f0f0f0;
    background-color: #f4f6f8; 
    color: var(--blue-dark);
  }
  .row-eta td {
    padding: 10px 12px;
    background-color: #ffffff;
    color: #2e7d32;
  }

  /* --- BADGES & ICONS --- */
  .src-badge {
    font-size: 0.65rem; font-weight: 700; padding: 4px 8px; border-radius: 4px;
    margin-right: 8px; display: inline-block; color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .bg-int { background: var(--grad-petrol); }
  .bg-eta { background: var(--grad-success); }

  .status-icon-box {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto;
    color: white;
    font-size: 0.9rem;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }
  .icon-match { background: var(--grad-success); }
  .icon-missing { background: var(--grad-warning); }
  .icon-diff { background: var(--grad-danger); }

  /* --- FILE ICONS (Enhanced) --- */
  .btn-icon-link {
    width: 36px; height: 36px; /* Larger */
    border-radius: 50%;
    background: white;
    display: inline-flex; align-items: center; justify-content: center;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
    text-decoration: none;
    font-size: 1.2rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 1px solid #eee;
  }
  .btn-icon-link:hover { 
    transform: translateY(-3px) scale(1.1); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  .link-disabled { color: #cfd8dc; cursor: default; background: transparent; border: none; box-shadow: none; }

  /* --- BUTTONS --- */
  .btn-sync {
    background: var(--petroleum-dark);
    color: white; border: none;
    padding: 8px 20px; border-radius: 6px;
    font-size: 0.9rem; cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .btn-sync:hover { background: #1d3842; }

  /* --- VERSION BADGES --- */
/* --- VERSION BADGES --- */
.badge-ver {
  font-size: 0.65rem; 
  font-weight: 600; 
  padding: 2px 6px;       /* Smaller padding */
  border-radius: 4px;
  margin-right: 8px; 
  display: inline-block;
  vertical-align: middle;
  transition: all 0.2s;
}

/* Normal / Standard Badge (Subtle) */
.badge-ver-std {
  background: #f1f3f4;    /* Very light gray */
  color: #78909c;         /* Muted blue-gray text */
  border: 1px solid #e0e0e0;
  font-size: 0.6rem;      /* Even smaller font */
  opacity: 0.8;
}

/* Warning Badge (Flagged) */
.badge-ver-warn {
  background: var(--grad-danger);
  color: white;
  border: 1px solid #c62828;
  box-shadow: 0 2px 4px rgba(211, 47, 47, 0.2);
}
</style>

<script>
/**
 * Loads the Reconciliation Dashboard
 * FIX: Added session check and robust error handling
 */
function loadEtaReconciliation() {
    // 1. Safety Check: Verify Login
    const userEmail = localStorage.getItem('userEmail');
    if (!userEmail) {
        console.warn("User email not found in localStorage. Dashboard might show limited data.");
    }

    const table = document.getElementById('main-reconcile-table');
    const loading = document.getElementById('eta-loading-state');
    const tbody = table.querySelector('tbody');

    // Clear old data safely
    if (tbody) {
        tbody.innerHTML = '';
    } else {
        // Create tbody if it doesn't exist to prevent errors
        table.appendChild(document.createElement('tbody'));
    }
    
    // Show loading state
    if (loading) {
        loading.style.display = 'block';
        loading.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Analyzing Data...';
    }

    google.script.run
      .withSuccessHandler((data) => {
          // Hide loading
          if (loading) loading.style.display = 'none';
          // Render data
          renderStackedRows(data);
      })
      .withFailureHandler(err => {
          if (loading) loading.innerHTML = `<div class="text-danger p-3">Error loading dashboard: ${err}</div>`;
      })
      .getReconciliationDashboardData(); // No arguments needed for read-only dashboard
}

function renderStackedRows(jsonStr) {
    const table = document.getElementById('main-reconcile-table');
    const loading = document.getElementById('eta-loading-state');
    
    if (table && table.tBodies) {
        while (table.tBodies.length > 0) { table.removeChild(table.tBodies[0]); }
    }
    
    if (loading) loading.style.display = 'none';

    if (!jsonStr) return;

    let response;
    try { 
        response = JSON.parse(jsonStr); 
    } catch(e) { 
        console.error("JSON Parse Error:", e); 
        return; 
    }

    if (typeof updateBatchSaveUI === 'function') {
        updateBatchSaveUI(response);
    }

    const data = response.data || [];

    if (data.length === 0) {
        if (loading) {
            loading.style.display = 'block'; 
            loading.innerHTML = 'No records found.'; 
        }
        return;
    }

    if(document.getElementById('stat-summary-text')) {
        document.getElementById('stat-summary-text').innerText = `${data.length} Records processed`;
    }

    const fmtDate = (dStr) => {
        if (!dStr) return '-';
        const d = new Date(dStr);
        if (isNaN(d.getTime())) return dStr;
        return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    };

    // --- INJECT CUSTOM CSS FOR BADGES ---
    if (!document.getElementById('reconcile-custom-css')) {
        const style = document.createElement('style');
        style.id = 'reconcile-custom-css';
        style.innerHTML = `
            #main-reconcile-table { border-collapse: separate; border-spacing: 0; }
            .reconcile-group { transition: box-shadow 0.2s; }
            .reconcile-group:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.08); transform: translateY(-1px); }
            .reconcile-group td { background-color: #fff; border-top: 1px solid #e9ecef; }
            .reconcile-group tr:first-child td { border-top: 1px solid #dee2e6; }
            .reconcile-group tr:last-child td { border-bottom: 1px solid #dee2e6; }
            .reconcile-group tr td:last-child { border-right: 1px solid #dee2e6; }
            
            /* NEW STATUS BADGE STYLES */
            .eta-status-badge {
                font-size: 0.75rem;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 600;
                margin-right: 5px;
                display: inline-block;
                vertical-align: middle;
            }
            .st-valid { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
            .st-submitted { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
            .st-invalid, .st-rejected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
            .st-cancelled { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
            .st-pending-cancel { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; } /* Orange for Cancelling */
        `;
        document.head.appendChild(style);
    }

    data.forEach(item => {
        const int = item.internal || {};
        const eta = item.eta || {};
        const reconStatus = item.status; // MATCHED, MISMATCH etc.
        const rowKey = item.key || int.serial || '-';

        // --- A. ICONS (Reconciliation Status) ---
        let iconHtml = '';
        if (reconStatus === 'MATCHED') {
           iconHtml = `<div class="status-icon-box icon-match" title="Matched"><i class="fas fa-check"></i></div>`;
        } else if (reconStatus === 'MISSING_ON_ETA') {
           iconHtml = `<div class="status-icon-box icon-missing" title="Missing on Portal"><i class="fas fa-question"></i></div>`;
        } else if (reconStatus && reconStatus.includes('MISMATCH')) {
           iconHtml = `<div class="status-icon-box icon-diff" title="Mismatch"><i class="fas fa-exclamation"></i></div>`;
        } else {
           iconHtml = `<div class="status-icon-box icon-missing" style="filter:grayscale(100%)" title="Missing Internal"><i class="fas fa-times"></i></div>`;
        }

        // --- B. DATA PREP ---
        const summary = int.summary || '<span class="text-muted small">-</span>';
        const serial = int.serial || rowKey; 
        
        let fullClientHtml = '';
        if (int.fullName) {
            fullClientHtml = `<span style="font-weight:400; font-size:0.85rem; color:#90a4ae; margin-left:6px;">(${int.fullName})</span>`;
        }
        
        const dateInt = fmtDate(int.date);
        const dateEta = eta.issueDate ? fmtDate(eta.issueDate) : '-';
        
        const totalInt = int.total ? Number(int.total).toLocaleString('en-EG', {minimumFractionDigits: 2}) : '0.00';
        const totalEta = eta.total ? Number(eta.total).toLocaleString('en-EG', {minimumFractionDigits: 2}) : '-';

        // --- C. VERSION BADGE ---
        let verBadgeHtml = '';
        if (eta.versionName) {
           const ver = String(eta.versionName).trim();
           const isStandard = (ver === '1.0' || ver === '1');
           const verClass = isStandard ? 'badge-ver-std' : 'badge-ver-warn';
           const label = ver.toLowerCase().startsWith('v') ? ver : `v${ver}`;
           verBadgeHtml = `<span class="badge-ver ${verClass}" title="Invoice Type Version">${label}</span>`;
        }

        // --- NEW: ETA PORTAL STATUS BADGE ---
        let etaStatusHtml = '';
        if (eta.status) {
            const st = String(eta.status).trim();
            let stClass = 'st-submitted'; // Default
            let icon = '';

            // Logic to assign colors
            if (st.toLowerCase() === 'valid') { stClass = 'st-valid'; icon = '<i class="fas fa-check-circle"></i>'; }
            else if (st.toLowerCase() === 'invalid') { stClass = 'st-invalid'; icon = '<i class="fas fa-times-circle"></i>'; }
            else if (st.toLowerCase() === 'cancelled') { stClass = 'st-cancelled'; icon = '<i class="fas fa-ban"></i>'; }
            else if (st.toLowerCase() === 'rejected') { stClass = 'st-rejected'; icon = '<i class="fas fa-times-circle"></i>'; }
            else if (st.includes('Cancelling') || st.includes('Rejecting')) { 
                stClass = 'st-pending-cancel'; 
                icon = '<i class="fas fa-exclamation-triangle"></i>'; 
            }

            etaStatusHtml = `<span class="eta-status-badge ${stClass}">${icon} ${st}</span>`;
        }

        // --- D. FILE ACTIONS ---
        const linkInt = int.link 
          ? `<a href="${int.link}" target="_blank" class="btn-icon-link" title="Open Internal Doc"><i class="fas fa-file-alt text-primary"></i></a>`
          : `<span class="btn-icon-link link-disabled"><i class="fas fa-file-alt"></i></span>`;

        let linkEta = '';
        if (eta.pdf) {
            linkEta = `<a href="${eta.pdf}" target="_blank" class="btn-icon-link" title="Open ETA PDF"><i class="fas fa-file-pdf text-success"></i></a>`;
        } else if (eta.uuid && (eta.status === 'Valid' || eta.status === 'Submitted')) {
            linkEta = `<button onclick="downloadSinglePdf('${rowKey}', '${eta.uuid}', this)" class="btn btn-sm text-secondary p-0 border-0" title="Download PDF to Drive" style="background:transparent;"><i class="fa-solid fa-cloud-arrow-down"></i></button>`;
        } else {
            linkEta = `<span class="btn-icon-link link-disabled"><i class="fas fa-file-pdf"></i></span>`;
        }

        // --- E. BUILD ROW GROUP ---
        const group = document.createElement('tbody');
        group.className = 'reconcile-group';

        // Styling Logic
        let accentColor = '#b0bec5'; 
        if (reconStatus === 'MATCHED') accentColor = '#2e7d32'; 
        else if (reconStatus === 'MISSING_ON_ETA') accentColor = '#f57c00'; 
        else if (reconStatus && reconStatus.includes('MISMATCH')) accentColor = '#c62828'; 

        group.style.borderBottom = "15px solid #f4f6f9"; 
        group.style.backgroundColor = "#ffffff";

        group.innerHTML = `
          <tr class="row-internal">
            <td rowspan="2" class="cell-common text-center" style="vertical-align: middle; border-left: 5px solid ${accentColor};">
                ${iconHtml}
            </td>
            
            <td rowspan="2" class="cell-common text-center" style="vertical-align: middle;">
              <span class="data-chip chip-serial" style="font-size: 0.9rem; font-weight: bold;">#${serial}</span>
              <div style="font-size:0.7rem; color:#90a4ae; margin-top:4px;">v${int.version||1}</div>
            </td>

            <td rowspan="2" class="cell-common col-summary-rtl" style="vertical-align: middle;">${summary}</td>
            
            <td>
               <span class="src-badge bg-int">INT</span>
               <span style="font-weight:600;">${int.client || 'Unknown Client'}</span>
               ${fullClientHtml}
            </td>
            
            <td class="text-center"><span class="data-chip chip-date">${dateInt}</span></td>
            
            <td class="text-end">
                <span class="data-chip chip-money chip-money-dark">${totalInt}</span>
            </td>
            
            <td class="text-center">${linkInt}</td>
          </tr>

          <tr class="row-eta">
             <td>
               <span class="src-badge bg-eta" title="Official Portal Data" style="padding: 4px 7px;"><i class="fas fa-globe"></i></span>
               ${etaStatusHtml} ${verBadgeHtml}
               ${eta.client 
                  ? `<span style="font-weight:500;">${eta.client}</span>` 
                  : '<span class="text-danger small fst-italic">Not found</span>'}
             </td>
             <td class="text-center"><span class="data-chip chip-date">${dateEta}</span></td>
             <td class="text-end">
                <span class="data-chip chip-money ${reconStatus && reconStatus.includes('MISMATCH') ? 'chip-money-err' : ''}">
                    ${totalEta}
                </span>
             </td>
             <td class="text-center">${linkEta}</td>
          </tr>
        `;

        table.appendChild(group);
    });
}

function refreshEtaData() {
    const btn = document.getElementById('btn-eta-sync');
    const originalText = btn.innerHTML;
    
    // 1. CRITICAL: Get User Email from Storage
    const userEmail = localStorage.getItem('userEmail');
    
    if (!userEmail) {
        alert("Session Error: Could not verify your identity. Please reload the page.");
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Syncing...';
    
    google.script.run
      .withSuccessHandler((res) => {
         btn.disabled = false;
         btn.innerHTML = originalText;
         
         if(res && res.success) {
            // Optional: Show a toast if you have a toast function, otherwise standard alert/log
            console.log("Sync Success: " + (res.message || "Data updated"));
            loadEtaReconciliation(); // Auto-refresh table
         } else {
            alert("Sync Failed: " + (res.message || "Unknown error"));
         }
      })
      .withFailureHandler((e) => {
         btn.disabled = false;
         btn.innerHTML = originalText;
         alert("System Error: " + e);
      })
      .refreshEtaCache(userEmail); // <--- FIX: Passing userEmail to Backend
}

function formatMoney(n) {
    return n ? Number(n).toLocaleString('en-EG', {minimumFractionDigits: 2}) : '0.00';
}


/**
 * --- NEW: BATCH SAVE CONTROLLER ---
 * Scans the dashboard data for Valid invoices missing PDFs
 * and displays a Batch Save button.
 */
function updateBatchSaveUI(data) {
    // 'data' comes from getReconciliationDashboardData()
    // data.data is the array of rows
    if (!data || !data.data) return;

    const missingPdfItems = [];
    
    // Scan for: Status=Valid/Submitted AND PDF=Empty AND UUID exists
    data.data.forEach(row => {
        if (row.eta && (row.eta.status === 'Valid' || row.eta.status === 'Submitted')) {
            if (!row.eta.pdf || row.eta.pdf === '') {
                if (row.eta.uuid && row.key) {
                    missingPdfItems.push({
                        internalId: row.key,
                        uuid: row.eta.uuid
                    });
                }
            }
        }
    });

    const headerContainer = document.querySelector('.eta-header-actions') || document.getElementById('eta-controls-area');
    // Ensure we have a container. If using your existing layout, you might need to adjust the selector.
    // Assuming the Sync button is inside a container we can append to.
    
    let batchBtn = document.getElementById('btn-batch-pdf');
    
    if (missingPdfItems.length > 0) {
        if (!batchBtn) {
            batchBtn = document.createElement('button');
            batchBtn.id = 'btn-batch-pdf';
            batchBtn.className = 'btn btn-warning ms-2'; // Bootstrap styling
            batchBtn.style.fontWeight = 'bold';
            
            // Insert after sync button
            const syncBtn = document.getElementById('btn-eta-sync');
            if (syncBtn && syncBtn.parentNode) {
                syncBtn.parentNode.insertBefore(batchBtn, syncBtn.nextSibling);
            }
        }
        
        batchBtn.innerHTML = `<i class="fas fa-file-download"></i> Save e-invoices to drive | ${missingPdfItems.length} remaining`;
        batchBtn.onclick = () => runBatchSave(missingPdfItems);
        batchBtn.style.display = 'inline-block';
        
    } else {
        if (batchBtn) batchBtn.style.display = 'none';
    }
}

/**
 * Triggers the Backend Batch Process
 */
function runBatchSave(items) {
    const btn = document.getElementById('btn-batch-pdf');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Downloading ${items.length} files...`;
    
    google.script.run
      .withSuccessHandler(res => {
          if (res.success) {
              alert(`Successfully saved ${res.saved} invoices to Drive.`);
              loadEtaReconciliation(); // Refresh to update links
          } else {
              alert("Error: " + res.message);
              btn.disabled = false;
              btn.innerHTML = originalText;
          }
      })
      .withFailureHandler(err => {
          alert("System Error: " + err);
          btn.disabled = false;
          btn.innerHTML = originalText;
      })
      .batchSaveEtaPdfs(items);
}

/**
 * Helper to download single PDF (assigned to row button)
 */
function downloadSinglePdf(internalId, uuid, btnElement) {
    if (!uuid || !internalId) return;
    
    const originalIcon = btnElement.innerHTML;
    btnElement.disabled = true;
    btnElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    
    google.script.run
      .withSuccessHandler(res => {
          if (res.success) {
              loadEtaReconciliation(); // Refresh UI
          } else {
              alert("Failed: " + res.message);
              btnElement.disabled = false;
              btnElement.innerHTML = originalIcon;
          }
      })
      .batchSaveEtaPdfs([{ internalId: internalId, uuid: uuid }]);
}

</script>
