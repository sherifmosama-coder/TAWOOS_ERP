<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/**
 * MATERIALS MODULE FRONTEND (v5.1 - Compact UI & Pro Reporting)
 */

let matState = {
    stock: [],
    warehouses: [],
    materialsGrouped: [], 
    transferRowCount: 0,
    currentHistory: [], 
    historyFilters: {
        startDate: "",
        endDate: "",
        types: [],
        warehouses: []
    },
    batchPreview: [],
    batchDate: null
};

// --- INIT ---
function initMaterialsModule() {
    const container = document.getElementById('materialsTabContent');
    if (!container) return;
    
    injectMaterialsStyles();
    container.innerHTML = getMaterialsHTML();
    
    // Default Dates
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    matState.historyFilters.startDate = firstDay.toISOString().split('T')[0];
    matState.historyFilters.endDate = today.toISOString().split('T')[0];

    document.getElementById('batch-date-picker').value = today;

    loadMaterialsData();
}

// --- STYLES ---

// --- COLOR HELPER ---
function getWhColor(colorName) {
    const map = {
        'Green': '#10b981', 'green': '#10b981',
        'Blue': '#3b82f6', 'blue': '#3b82f6',
        'Purple': '#8b5cf6', 'purple': '#8b5cf6',
        'Orange': '#f59e0b', 'orange': '#f59e0b',
        'Red': '#ef4444', 'red': '#ef4444',
        'Yellow': '#eab308', 'yellow': '#eab308',
        'Gray': '#64748b', 'Grey': '#64748b'
    };
    return map[colorName] || colorName || '#64748b';
}

function injectMaterialsStyles() {
    if (document.getElementById('materials-styles')) return;
    const style = document.createElement('style');
    style.id = 'materials-styles';
    style.innerHTML = `
:root { --mat-primary: #2563eb; --mat-bg: #f8fafc; --mat-surface: #ffffff; --mat-border: #e2e8f0; --mat-text: #334155; --mat-text-light: #64748b; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Layout & Nav (Browser Tabs Style) */
.mat-container { padding: 25px; font-family: 'Tajawal', sans-serif; direction: rtl; background: var(--mat-bg); min-height: 85vh; }

.mat-sub-nav { display: flex; gap: 6px; background: #cbd5e1; /* Tab Bar Background */padding: 10px 25px 0 25px; /* Padding for tabs to sit inside */border-bottom: 5px solid #0d9488; /* Thick Teal Line */margin-bottom: 25px; border-radius: 8px 8px 0 0; /* Rounded top corners for the bar */
}

.mat-nav-btn { background: rgba(255,255,255,0.4); /* Inactive Tab */border: none; padding: 10px 24px; font-size: 0.95rem; font-weight: 700; color: #475569; border-radius: 12px 12px 0 0; /* Tab Shape */cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; position: relative;top: 0px; 
}

.mat-nav-btn:hover { background: rgba(255,255,255,0.7); color: #1e293b;
}

.mat-nav-btn.active { background: #ffffff; /* Active White Card */color: #0f766e; /* Teal Text */opacity: 1; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); /* Subtle lift */margin-bottom: -5px; /* Connect to the bottom border (optional overlap) */padding-bottom: 15px; /* Extend down to cover the border line if desired *//* Alternatively, just sit on top: */margin-bottom: 0;padding-bottom: 10px;
}

.mat-nav-btn i { font-size: 1.1em; opacity: 0.8; }
.mat-nav-btn.active i { opacity: 1; color: #0d9488; }

/* Content, Inputs & Cards */
.mat-content { display: none; animation: fadeIn 0.3s ease; } .mat-content.active { display: block; }
.mat-card { background: var(--mat-surface); border-radius: 16px; border: 1px solid var(--mat-border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; }
.mat-input-group { margin-bottom: 15px; }
.mat-input-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--mat-text-light); margin-bottom: 6px; }
.mat-input { width: 100%; padding: 10px; border: 1px solid var(--mat-border); border-radius: 8px; font-size: 0.95rem; background: #f8fafc; transition: 0.2s; }
.mat-input:focus { outline: none; border-color: var(--mat-primary); background: #fff; }
.mat-input-compact { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; background: rgba(255,255,255,0.8); transition: 0.2s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
.mat-input-compact:focus { background: #fff; border-color: var(--mat-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); outline: none; }

/* Report Modal & Tables */
.report-modal { width: 95vw !important; height: 95vh !important; max-width: 1400px; display: flex; flex-direction: column; }
.report-header { padding: 6px 10px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; height: auto; }
.report-body { padding: 10px 20px; overflow-y: auto; flex-grow: 1; background: #fff; display: flex; flex-direction: column; gap: 10px; overscroll-behavior: contain; }
.report-footer { padding: 10px 20px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; }
.report-summary-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 5px; }
.summary-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
.summary-label { font-size: 0.75rem; color: #64748b; margin-bottom: 2px; }
.summary-val { font-size: 1.1rem; font-weight: 800; color: #1e293b; line-height: 1.2; }
.report-filters { display: grid; grid-template-columns: 140px 1.5fr 2fr; gap: 15px; background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
.date-stack { display: flex; flex-direction: column; gap: 5px; } .date-stack input { padding: 4px 8px; font-size: 0.85rem; height: 30px; }
.report-table-wrapper { border: 1px solid #e2e8f0; border-radius: 8px; overflow-x: auto; width: 100%; flex-grow: 1; }
.report-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.report-table th { background: #e2e8f0; padding: 8px; text-align: center; border: 1px solid #cbd5e1; font-weight: bold; color: #334155; position: sticky; top: 0; z-index: 10; }
.report-table td { padding: 6px; border: 1px solid #e2e8f0; text-align: center; color: #334155; }
.report-table tr:hover { background: #f8fafc; } .report-table tr.row-transfer { background: #f0fdf4; }
.val-pos { color: #166534; font-weight: bold; } .val-neg { color: #991b1b; font-weight: bold; } .val-zero { color: #cbd5e1; font-size: 0.8em; }
.balance-col { background: #f0f9ff; font-weight: bold; border-left: 2px solid #bae6fd !important; color: #0369a1 !important; }

/* Modals & Popovers */
.custom-confirm-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.custom-confirm-modal { background: #fff; width: 450px; max-width: 90%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; animation: fadeIn 0.2s ease-out; font-family: 'Tajawal', sans-serif; direction: rtl; }
.custom-confirm-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.custom-confirm-body { padding: 25px 20px; color: #475569; line-height: 1.6; }
.custom-confirm-footer { padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end; }
.search-modal { width: 400px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
.wh-popover { position: fixed; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); padding: 10px; z-index: 10000; min-width: 200px; font-family: 'Tajawal', sans-serif; display: none; animation: fadeIn 0.2s ease-out; pointer-events: auto; }
.popover-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; } .popover-row:last-child { border-bottom: none; }
.pop-wh { color: #64748b; font-weight: 600; } .pop-qty { font-weight: bold; color: #334155; font-family: monospace; }
.wh-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

/* Components: Chips, Buttons, Checkboxes */
.stock-pill { display: inline-flex; align-items: center; justify-content: center; height: 24px; padding: 0 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; min-width: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.stock-pill.ok { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #14532d; }
.stock-pill.low { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #7f1d1d; }
.stock-pill.none { background: #f1f5f9; color: #94a3b8; }
.btn-mat { padding: 8px 16px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
.btn-primary { background: var(--mat-primary); color: white; } .btn-success { background: #10b981; color: white; } .btn-ghost { background: transparent; color: #64748b; border: 1px dashed #cbd5e1; }
.btn-mat-gradient { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
.btn-mat-gradient:hover { transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5); filter: brightness(110%); }
.btn-action-icon { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; color: #64748b; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
.btn-action-icon:hover { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
.checkbox-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; background: #fff; color: #64748b; padding: 5px 12px; border-radius: 6px; border: 1px solid #cbd5e1; border-bottom: 3px solid #cbd5e1; cursor: pointer; transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1); user-select: none; }
.checkbox-item:hover { background: #f8fafc; border-color: #94a3b8; }
.checkbox-item:has(input:checked) { transform: translateY(2px); border-bottom-width: 1px; margin-bottom: 2px; background: #f1f5f9; color: #0f172a; border-color: #64748b; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
.checkbox-item input { accent-color: #475569; } .checkbox-item input:checked + span { color: inherit; font-weight: 600; }

/* Grid & Cards (Modern) */
.mat-grid-section { margin-bottom: 10px; animation: fadeIn 0.3s ease-out; }
.mat-grid-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; color: #334155; font-weight: 800; font-size: 1.1rem; }
.mat-grid-header i { color: var(--mat-primary); opacity: 0.8; }
.mat-grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
.mat-stock-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
.mat-stock-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -6px rgba(0,0,0,0.12); border-color: #cbd5e1; }
.mat-stock-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #2563eb, #0f172a); }
.card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.card-ref { background: #f1f5f9; color: #64748b; font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; letter-spacing: 0.5px; border: 1px solid #e2e8f0; }
.card-name { font-weight: 700; color: #1e293b; font-size: 1rem; margin-bottom: 15px; line-height: 1.4; flex-grow: 1; }
.card-stats { display: flex; align-items: center; justify-content: center; background: #f8fafc; padding: 10px 12px; border-radius: 10px; border: 1px solid #f1f5f9; }
.card-qty-wrapper { display: flex; flex-direction: column; align-items: center; }
.card-lbl { font-size: 0.7rem; color: #94a3b8; font-weight: 600; margin-bottom: 2px; }
.card-total-chip { font-family: monospace; font-size: 1.3rem; font-weight: 800; color: #0f172a; cursor: pointer; border-bottom: 2px dotted #cbd5e1; display: inline-block; line-height: 1; user-select: none; }
.card-total-chip:hover, .card-total-chip.active { color: var(--mat-primary); border-color: var(--mat-primary); background: #eff6ff; border-radius: 4px; }

/* Batch UI */
.batch-container { border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); background: #fff; }
.batch-header { display: grid; grid-template-columns: 40px 2fr 2fr 1fr 40px; gap: 10px; padding: 12px 20px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #f8fafc; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.5px; align-items: center; border-bottom: 3px solid #475569; }
.batch-row { display: grid; gap: 10px; padding: 10px 20px; align-items: center; background: linear-gradient(to bottom, #ffffff, #f8fafc); border-bottom: 1px solid #e2e8f0; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); position: relative; grid-template-columns: 40px 2fr 2fr 2fr 1fr 40px !important;}
.batch-row:hover { transform: translateY(-2px) scale(1.005); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); z-index: 5; border-color: transparent; background: linear-gradient(to bottom, #ffffff, #f1f5f9); }
.batch-row.error-row { background: #fff5f5; border-left: 4px solid #ef4444; }
.error-msg-tooltip { grid-column: 1 / -1; color: #b91c1c; font-size: 0.8rem; font-weight: bold; padding: 5px 0 0 40px; display: flex; align-items: center; gap: 5px; animation: fadeIn 0.3s ease; }
/* Collapsible Grid Logic */
.mat-grid-header { cursor: pointer; user-select: none; transition: all 0.2s; border-radius: 8px; padding: 10px; }
.mat-grid-header:hover { background: #f1f5f9; }
.grid-chevron { transition: transform 0.2s; color: #cbd5e1; margin-left: 10px; font-size: 0.9em; }
/* State: Collapsed */
.mat-grid-section.collapsed .mat-grid-cards { display: none; }
/* RTL Rotation: Rotate 90deg turns "Down" arrow to "Left" (pointing at text) */
.mat-grid-section.collapsed .grid-chevron { transform: rotate(90deg); }
/* New Batch Styles */
.batch-uploader { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px; text-align: center; transition: 0.2s; background: #f8fafc; cursor: pointer; }
.batch-uploader:hover { border-color: var(--mat-primary); background: #eff6ff; }
.batch-mode-toggle { display: flex; background: #e2e8f0; padding: 4px; border-radius: 8px; width: fit-content; margin-bottom: 20px; }
.mode-btn { padding: 6px 16px; border: none; background: transparent; border-radius: 6px; font-weight: 600; color: #64748b; cursor: pointer; transition: 0.2s; }
.mode-btn.active { background: #fff; color: var(--mat-primary); shadow: 0 1px 2px rgba(0,0,0,0.1); }
.preview-grid { max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 20px; }
.preview-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.preview-table th { position: sticky; top: 0; background: #f1f5f9; padding: 8px; text-align: right; border-bottom: 2px solid #e2e8f0; }
.preview-table td { padding: 6px 8px; border-bottom: 1px solid #e2e8f0; }
.row-ok { background: #f0fdf4; } /* Green tint */
.row-diff { color: #d97706; font-weight:bold; }
.row-match { color: #94a3b8; }

/* Utility */
.hidden { display: none !important; }
/* Manual Adjust Grid Styles */
.adj-grid-header { display: grid; grid-template-columns: 140px 2fr 120px 100px 100px 1.5fr 40px; gap: 10px; padding: 10px 15px; background: #f1f5f9; border-radius: 8px 8px 0 0; font-weight: bold; color: #475569; font-size: 0.85rem; border: 1px solid #e2e8f0; }
.adj-row { display: grid; grid-template-columns: 140px 2fr 120px 100px 100px 1.5fr 40px; gap: 10px; padding: 10px 15px; background: #fff; border: 1px solid #e2e8f0; border-top: none; align-items: start; transition: 0.2s; }
.adj-row:hover { background: #f8fafc; }
.adj-row:last-child { border-radius: 0 0 8px 8px; }
/* Status & Diff Badges */
.adj-status-box { display: flex; flex-direction: column; gap: 2px; font-size: 0.75rem; justify-content: center; height: 100%; }
.curr-lbl { color: #64748b; font-weight: 600; }
.diff-lbl { font-weight: bold; padding: 1px 6px; border-radius: 4px; display: inline-block; width: fit-content; }
.diff-pos { color: #15803d; background: #dcfce7; }
.diff-neg { color: #b91c1c; background: #fee2e2; }
.diff-zero { color: #94a3b8; background: #f1f5f9; }
/* Compact Inputs */
.adj-input { width: 100%; padding: 6px 8px; font-size: 0.9rem; border: 1px solid #cbd5e1; border-radius: 6px; }
.adj-input:focus { border-color: var(--mat-primary); outline: none; }
.adj-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
/* Layer Picker & Cost Hint Styles */
.layer-select { width: 100%; font-family: monospace; font-size: 0.8rem; background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 4px; border-radius: 4px; }
.cost-hint { font-size: 0.75rem; color: #10b981; margin-top: 4px; white-space: nowrap; font-weight: bold; }
/* Update Transfer Grid to support 5 columns */
.batch-header { grid-template-columns: 40px 2fr 2fr 2fr 1fr 40px !important; } 
.batch-row { grid-template-columns: 40px 2fr 2fr 2fr 1fr 40px !important; }


    `;
    document.head.appendChild(style);
}

// --- HTML STRUCTURE ---
function getMaterialsHTML() {
    return `
    <div class="mat-container">
        
        <div class="mat-sub-nav">
            <button class="mat-nav-btn active" id="mat-btn-dash" onclick="switchMatTab('dash')">
                <i class="fas fa-cubes"></i>
                رصيد الخامات
            </button>
            <button class="mat-nav-btn" id="mat-btn-transfers" onclick="switchMatTab('transfers')">
                <i class="fas fa-dolly-flatbed"></i>
                تحويل مخزني
            </button>
            <button class="mat-nav-btn" id="mat-btn-adjust" onclick="switchMatTab('adjust')">
                <i class="fas fa-clipboard-check"></i>
                جرد و تسويات
            </button>
        </div>

        <div id="mat-content-dash" class="mat-content active">
            
            <div class="mat-card" style="margin-bottom: 25px; padding: 15px 25px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:40px; height:40px; background:linear-gradient(135deg, #e0f2fe, #bae6fd); color:#0284c7; border-radius:10px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 4px rgba(0,0,0,0.05);"><i class="fas fa-cubes fa-lg"></i></div>
                        <div>
                            <h5 style="margin:0; font-weight:700; color:#1e293b;">رصيد الخامات الحالي</h5>
                            <small style="color:#64748b;">نظرة عامة على المخزون (Real-time Stock)</small>
                        </div>
                    </div>
                    <button class="btn-mat btn-ghost" onclick="openGlobalSearchModal()" style="color:#2563eb; border-color:#bfdbfe; background:#eff6ff;">
                        <i class="fas fa-history"></i> سجل حركة صنف
                    </button>
                </div>

                <div style="display:flex; gap:15px; align-items:center;">
                    <i class="fas fa-filter text-primary"></i>
                    <select class="mat-input" style="width:200px;" id="mat-filter-wh" onchange="renderStockTable()">
                        <option value="ALL">كل المخازن</option>
                    </select>
                    <div style="flex-grow:1; position:relative;">
                        <input type="text" class="mat-input" id="mat-filter-search" placeholder="بحث سريع..." onkeyup="renderStockTable()">
                    </div>
                    <button class="btn-mat btn-ghost" onclick="loadMaterialsData()"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>

            <div id="mat-stock-grid" style="padding-bottom: 50px;">
                <div style="text-align:center; padding:40px; color:#94a3b8;">
                    <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>جاري تحميل البيانات...
                </div>
            </div>
            
        </div>

        <div id="mat-content-transfers" class="mat-content">
            <div class="mat-card">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;">
                    <div style="width:40px; height:40px; background:linear-gradient(135deg, #eff6ff, #dbeafe); color:var(--mat-primary); border-radius:10px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 4px rgba(37,99,235,0.1);"><i class="fas fa-dolly-flatbed"></i></div>
                    <div>
                        <h5 style="margin:0; font-weight:700; color:#1e293b;">تحويل مخزني مجمع</h5>
                        <small style="color:#64748b;">نقل خامات بين المخازن (Batch Transfer)</small>
                    </div>
                </div>
                
                <form id="mat-transfer-form" onsubmit="event.preventDefault(); preSubmitBatchTransfer();">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:25px;">
                        <div class="mat-input-group">
                            <label><i class="fas fa-upload" style="color:#ef4444; margin-left:5px;"></i> من مخزن (المصدر)</label>
                            <select id="tx-source-wh" class="mat-input wh-select" style="background:#fff;" required onchange="onSourceWhChange()"></select>
                        </div>
                        <div class="mat-input-group">
                            <label><i class="fas fa-download" style="color:#10b981; margin-left:5px;"></i> إلى مخزن (المستلم)</label>
                            <select id="tx-dest-wh" class="mat-input wh-select" style="background:#fff;" required></select>
                        </div>
                    </div>

                    <div class="batch-container">
                        <div class="batch-header" style="grid-template-columns: 40px 2fr 2fr 2fr 1fr 40px;">
                            <div style="text-align:center;">#</div>
                            <div>الخامة الأساسية</div>
                            <div>النوع / المورد</div>
                            <div>باتش (FIFO Layer)</div>
                            <div>الكمية / متاح</div>
                            <div style="text-align:center;"><i class="fas fa-trash-alt" style="opacity:0.5;"></i></div>
                        </div>
                        <div id="transfer-rows-container"></div>
                    </div>

                    <div style="display:flex; justify-content:space-between; margin-top:20px;">
                        <button type="button" class="btn-mat btn-ghost" onclick="addTransferRow()">
                            <i class="fas fa-plus"></i> إضافة صف
                        </button>
                        <button type="submit" class="btn-mat-gradient" id="btn-submit-transfer">
                            <i class="fas fa-check-circle"></i> تنفيذ التحويل
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="mat-content-adjust" class="mat-content">
            
            <div class="mat-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h5 style="margin:0; font-weight:700; color:#1e293b;">إدارة التسويات والجرد</h5>
                        <small style="color:#64748b;">تحديث الأرصدة يدوياً أو عبر ملف Excel</small>
                    </div>
                    <div class="batch-mode-toggle">
                        <button class="mode-btn active" id="btn-mode-single" onclick="switchAdjustMode('single')">إدخال يدوي</button>
                        <button class="mode-btn" id="btn-mode-batch" onclick="switchAdjustMode('batch')">رفع ملف جرد (Excel)</button>
                    </div>
                </div>

                <div id="adjust-single-panel">
                    
                    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                        <label style="font-weight:600; color:#334155;">تاريخ العملية:</label>
                        <input type="date" id="manual-adj-date" class="mat-input" style="width:160px;">
                        <div style="flex-grow:1; text-align:left; color:#64748b; font-size:0.85rem;">
                            <i class="fas fa-info-circle"></i> أدخل الكمية النهائية (Target Quantity). النظام سيحسب الفرق تلقائياً.
                        </div>
                    </div>

                    <div class="adj-container">
                        <div class="adj-grid-header">
                            <div>المخزن</div>
                            <div>الصنف</div>
                            <div>الوضع الحالي</div>
                            <div>الرصيد الفعلي</div>
                            <div>التكلفة</div>
                            <div>ملاحظات</div>
                            <div style="text-align:center"><i class="fas fa-trash-alt"></i></div>
                        </div>

                        <div id="manual-adjust-rows"></div>

                        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                            <button class="btn-mat btn-ghost" onclick="addAdjustmentRow()">
                                <i class="fas fa-plus"></i> إضافة صنف آخر
                            </button>
                            <button class="btn-mat-gradient" onclick="saveManualAdjustments()">
                                <i class="fas fa-save"></i> حفظ العمليات
                            </button>
                        </div>
                    </div>
                </div>

                <div id="adjust-batch-panel" class="hidden">
                    <div style="display:flex; gap:15px; background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px; align-items:center;">
                        <div class="mat-input-group" style="margin:0;">
                            <label>تاريخ الجرد</label>
                            <input type="date" id="batch-date-picker" class="mat-input">
                        </div>
                        <div style="flex-grow:1;">
                            <p style="margin:0; font-size:0.85rem; color:#64748b;">
                                1. اختر التاريخ. 2. حمل ملف الجرد (يحتوي على الأرصدة الحالية). 3. املأ العمود "Actual Qty".
                            </p>
                        </div>
                        <button class="btn-mat btn-success" onclick="downloadStockTakeTemplate()">
                            <i class="fas fa-file-download"></i> تحميل القالب
                        </button>
                    </div>

                    <div class="batch-uploader" onclick="document.getElementById('file-upload').click()">
                        <input type="file" id="file-upload" accept=".xlsx" style="display:none" onchange="handleBatchUpload(this)">
                        <i class="fas fa-cloud-upload-alt fa-3x" style="color:#cbd5e1; margin-bottom:10px;"></i>
                        <h4 style="margin:0; color:#475569;">اضغط لرفع ملف الجرد المعبأ</h4>
                        <p style="margin:5px 0 0; color:#94a3b8; font-size:0.9rem;">يدعم ملفات Excel (.xlsx) فقط</p>
                    </div>

                    <div id="batch-preview-container" class="hidden">
                        <div style="display:flex; justify-content:space-between; margin-top:20px; align-items:center;">
                            <h5 style="margin:0;">معاينة الفروقات (Diff Preview)</h5>
                            <button class="btn-mat-gradient" onclick="submitBatchToBackend()">
                                <i class="fas fa-check-double"></i> اعتماد الفروقات
                            </button>
                        </div>
                        <div class="preview-grid">
                            <table class="preview-table" id="batch-preview-table">
                                <thead>
                                    <tr>
                                        <th>المخزن</th>
                                        <th>الخامة</th>
                                        <th>الرصيد المسجل</th>
                                        <th>الرصيد الفعلي (مدخل)</th>
                                        <th>الفرق (Delta)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="mat-search-modal" class="custom-confirm-backdrop" style="display:none;">
            <div class="search-modal">
                <div style="margin-bottom:20px;">
                    <div style="width:50px; height:50px; background:#eff6ff; color:#2563eb; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:15px;">
                        <i class="fas fa-search fa-lg"></i>
                    </div>
                    <h5 style="margin:0; color:#1e293b;">بحث عن حركة صنف</h5>
                    <p style="margin:5px 0 0; color:#64748b; font-size:0.9rem;">اختر الخامة لعرض التقرير التفصيلي</p>
                </div>
                
                <div class="mat-input-wrapper" style="text-align:right; margin-bottom:20px;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold; font-size:0.85rem;">اسم الخامة او الكود</label>
                    <input list="global-mat-list" id="global-search-input" class="mat-input" placeholder="اكتب للبحث..." style="font-size:1rem; padding:12px;">
                </div>
                
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn-mat btn-ghost" onclick="closeGlobalSearchModal()">إغلاق</button>
                    <button class="btn-mat btn-primary" onclick="submitGlobalSearch()">عرض التقرير</button>
                </div>
            </div>
        </div>

        <div id="mat-report-modal" class="custom-confirm-backdrop" style="display:none;">
            <div class="custom-confirm-modal report-modal">
                <div class="report-header">
                    <div>
                        <h4 id="report-title">تقرير حركة صنف</h4>
                        <small id="report-subtitle" style="color:#64748b;">Ref ID</small>
                    </div>
                    <button class="btn-icon-only" onclick="closeReportModal()"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="report-body">
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>الفترة الزمنية</label>
                            <div class="date-stack">
                                <input type="date" class="mat-input" id="rep-start-date" onchange="renderReport()">
                                <input type="date" class="mat-input" id="rep-end-date" onchange="renderReport()">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>نوع الحركة</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" class="rep-type-chk" value="OPENING_BALANCE" checked onchange="renderReport()"> <span>رصيد افتتاحي</span></label>
                                <label class="checkbox-item"><input type="checkbox" class="rep-type-chk" value="TRANSFER" checked onchange="renderReport()"> <span>تحويل</span></label>
                                <label class="checkbox-item"><input type="checkbox" class="rep-type-chk" value="ADJUSTMENT" checked onchange="renderReport()"> <span>تسوية</span></label>
                                <label class="checkbox-item"><input type="checkbox" class="rep-type-chk" value="PURCHASE" checked onchange="renderReport()"> <span>مشتريات</span></label>
                                <label class="checkbox-item"><input type="checkbox" class="rep-type-chk" value="RETURN" checked onchange="renderReport()"> <span>مرتجعات</span></label>
                                <label class="checkbox-item"><input type="checkbox" class="rep-type-chk" value="PRODUCTION" checked onchange="renderReport()"> <span>إنتاج</span></label>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>المخازن</label>
                            <div class="checkbox-group" id="rep-wh-filters"></div>
                        </div>
                    </div>

                    <div class="report-summary-bar">
                        <div class="summary-card">
                            <div class="summary-label">رصيد أول المدة</div>
                            <div class="summary-val" id="sum-start-bal">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">إجمالي الوارد (+)</div>
                            <div class="summary-val" style="color:#166534" id="sum-total-in">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">إجمالي المنصرف (-)</div>
                            <div class="summary-val" style="color:#991b1b" id="sum-total-out">-</div>
                        </div>
                        <div class="summary-card" style="background:#f0f9ff; border-color:#bae6fd;">
                            <div class="summary-label">رصيد آخر المدة</div>
                            <div class="summary-val" style="color:#0369a1" id="sum-end-bal">-</div>
                        </div>
                    </div>

                    <div class="report-table-wrapper">
                        <table class="report-table" id="report-table"></table>
                    </div>
                </div>

                <div class="report-footer">
                    <button class="btn-mat btn-success" onclick="exportReportToExcel()"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                    <button class="btn-mat btn-ghost" onclick="closeReportModal()">إغلاق</button>
                </div>
            </div>
        </div>

        <datalist id="global-main-list"></datalist>
        <datalist id="global-mat-list"></datalist>
    </div>
    `;
}

// --- LOGIC ---

function switchMatTab(tab) {
    // 1. Standard UI Toggling
    document.querySelectorAll('.mat-nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.mat-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`mat-btn-${tab}`).classList.add('active');
    document.getElementById(`mat-content-${tab}`).classList.add('active');

    // 2. Auto-Initialize Adjust Tab if empty
    if (tab === 'adjust') {
        const rowsContainer = document.getElementById('manual-adjust-rows');
        // If the grid is empty (first load), add the first row automatically
        if (rowsContainer && rowsContainer.children.length === 0) {
            initManualAdjustTab();
        }
    }
}

function switchAdjustMode(mode) {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-mode-${mode}`).classList.add('active');
    
    if(mode === 'single') {
        document.getElementById('adjust-single-panel').classList.remove('hidden');
        document.getElementById('adjust-batch-panel').classList.add('hidden');
    } else {
        document.getElementById('adjust-single-panel').classList.add('hidden');
        document.getElementById('adjust-batch-panel').classList.remove('hidden');
    }
}

// --- COST LOOKUP LOGIC ---

function fetchItemLastCost(input) {
    const refId = input.value;
    const hintEl = document.getElementById('cost-hint-msg');
    
    // Reset if empty
    if(!refId) {
        hintEl.innerHTML = '<i class="fas fa-info-circle"></i> اتركه فارغاً لاستخدام آخر سعر مسجل';
        hintEl.style.color = '#64748b';
        return;
    }

    // Show Loading
    hintEl.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> جاري البحث عن آخر سعر...';
    hintEl.style.color = '#3b82f6'; // Blue

    google.script.run.withSuccessHandler(res => {
        if(res.success && res.cost > 0) {
            // Success: Found a price
            hintEl.innerHTML = `<i class="fas fa-check-circle"></i> آخر سعر مسجل: <strong>${parseFloat(res.cost).toFixed(2)}</strong> (سيتم استخدامه)`;
            hintEl.style.color = '#10b981'; // Green
        } else {
            // Failure: New Item or No History
            hintEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> صنف جديد (لا يوجد سعر سابق). يرجى الإدخال يدوياً.`;
            hintEl.style.color = '#ef4444'; // Red
        }
    }).api_getLastCost(refId);
}

function loadMaterialsData(preserveForm = false) {
    google.script.run
        .withSuccessHandler(resString => {
            let res;
            try { res = JSON.parse(resString); } catch(e) { return; }
            if (res.success) {
                matState.stock = res.stock;
                matState.warehouses = res.warehouses;
                matState.materialsGrouped = res.materialsGrouped;
                
                // 1. Always update Dashboard Table
                renderStockTable();
                
                // 2. Only reset UI elements if NOT preserving form
                if (!preserveForm) {
                    populateWhSelects(); // Resets WH dropdowns
                    populateDataLists();
                    
                    // Reset Counter and Form Rows
                    matState.transferRowCount = 0;
                    document.getElementById('transfer-rows-container').innerHTML = '';
                    addTransferRow(); 
                } else {
                    // 3. If Preserving Form: Just update the stock chips (red/green pills)
                    // We don't touch the rows or WH selectors
                    populateDataLists(); // Safe to update datalists
                    updateAllStockChips();
                }
            }
        })
        .getMaterialsInitialData();
}

// --- REPORT ENGINE PRO ---

function openReportModal(refId, name) {
    document.body.style.overflow = 'hidden'; // Lock Background
    document.getElementById('mat-report-modal').style.display = 'flex';
    document.getElementById('report-title').textContent = name;
    document.getElementById('report-subtitle').textContent = refId;
    document.getElementById('report-table').innerHTML = '<tr><td colspan="10" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> جاري جلب البيانات...</td></tr>';
    
    // Set Filters Default
    document.getElementById('rep-start-date').value = matState.historyFilters.startDate;
    document.getElementById('rep-end-date').value = matState.historyFilters.endDate;

    // Build Warehouse Checkboxes
    const whCont = document.getElementById('rep-wh-filters');
    whCont.innerHTML = '';
    // Inside openReportModal function loop:
    matState.warehouses.forEach(wh => {
    const color = getWhColor(wh.color);
    const label = document.createElement('label');
    label.className = 'checkbox-item';
    // Add colored border-right to the checkbox item
    label.style.borderRight = `4px solid ${color}`;

    label.innerHTML = `<input type="checkbox" class="rep-wh-chk" value="${wh.id}" checked onchange="renderReport()"> <span>${wh.name}</span>`;
    whCont.appendChild(label);
});

    // Fetch History
    google.script.run
        .withSuccessHandler(resString => {
            const res = JSON.parse(resString);
            if(res.success) {
                matState.currentHistory = res.history;
                matState.liveStock = res.liveStock; // [Fix 3] Store live stock
                renderReport();
            } else {
                alert(res.message);
            }
        })
        .getMaterialDetails(refId);
}

function closeReportModal() {
    document.body.style.overflow = ''; // Release Background
    document.getElementById('mat-report-modal').style.display = 'none';
}

function renderReport() {
    const rawData = matState.currentHistory || [];
    const liveStockTotal = matState.liveStock || 0; // [Fix 3] From backend
    const table = document.getElementById('report-table');
    
    // 1. Get Filters
    const startDate = new Date(document.getElementById('rep-start-date').value);
    const endDate = new Date(document.getElementById('rep-end-date').value);
    endDate.setHours(23, 59, 59);

    const checkedWhs = Array.from(document.querySelectorAll('.rep-wh-chk:checked')).map(cb => cb.value);
    const checkedTypes = Array.from(document.querySelectorAll('.rep-type-chk:checked')).map(cb => cb.value);

    // 2. Sort (Fix #4: Sort on Frontend Only) & Group
    const sortedRaw = [...rawData].sort((a, b) => new Date(a.date) - new Date(b.date));
    const groupedData = groupTransactions(sortedRaw); // Uses new logic

    // 3. Calculate Balances
    let startBal = 0;
    let totalIn = 0;
    let totalOut = 0;
    let runningBalance = 0;

    // Calculate Opening Balance
    groupedData.forEach(tx => {
        const txDate = new Date(tx.date);
        if (txDate < startDate) {
            runningBalance += getNetEffect(tx, checkedWhs);
        }
    });

    startBal = runningBalance; 

    // 4. Build Header
    // [Fix 1] Added 'سعر الوحدة' (Unit Cost)
    // [Fix 5] Changed 'الرصيد' to 'الرصيد المحدد' (Filtered Balance)
    let thead = `<thead><tr>
        <th style="width:90px;">التاريخ</th>
        <th style="width:110px;">النوع</th>
        <th>الملاحظات</th>
        <th style="width:80px;">سعر الوحدة</th>`;
    
    checkedWhs.forEach(whId => {
        const whObj = matState.warehouses.find(w => w.id === whId);
        const whName = whObj?.name || whId;
        const color = whObj ? getWhColor(whObj.color) : '#64748b';
        thead += `<th style="width:90px; border-top: 4px solid ${color};">${whName}</th>`;
    });
    
    thead += `<th class="balance-col" style="width:90px;">الرصيد المحدد</th></tr></thead>`;
    table.innerHTML = thead;

    // 5. Build Opening Row
    let tbody = `<tbody>
        <tr style="background:#fff7ed; font-weight:bold;">
            <td colspan="${4 + checkedWhs.length}">رصيد ما قبل الفترة (${startDate.toLocaleDateString('en-GB')})</td>
            <td class="balance-col">${parseFloat(startBal.toFixed(2))}</td>
        </tr>
    `;

    // 6. Iterate Visible Transactions
    groupedData.forEach(tx => {
        const txDate = new Date(tx.date);
        
        if (txDate < startDate || txDate > endDate) return;
        if (!isTransactionRelevant(tx, checkedWhs)) return;
        if (!isTypeSelected(tx.displayType, checkedTypes)) return;

        const netChange = getNetEffect(tx, checkedWhs);
        runningBalance += netChange;

        if (netChange > 0) totalIn += netChange;
        if (netChange < 0) totalOut += Math.abs(netChange);

        const dateStr = txDate.toLocaleDateString('en-GB');
        let rowClass = tx.displayType === 'TRANSFER' ? 'row-transfer' : '';
        
        // [Fix 1] Display Cost
        const costDisplay = tx.cost ? parseFloat(tx.cost).toFixed(2) : '-';

        let rowHtml = `<tr class="${rowClass}">
            <td>${dateStr}</td>
            <td style="font-weight:600; font-size:0.85rem;">${translateType(tx.displayType)}</td>
            <td style="text-align:right; font-size:0.85rem; color:#64748b;">${tx.notes || '-'}</td>
            <td style="font-family:monospace; color:#475569;">${costDisplay}</td>`;
        
        checkedWhs.forEach(whId => {
            const qty = tx.whEffects[whId];
            if (qty !== undefined && qty !== 0) {
                const colorClass = qty > 0 ? 'val-pos' : 'val-neg';
                const sign = qty > 0 ? '+' : '';
                rowHtml += `<td class="${colorClass}" style="direction:ltr;">${sign}${qty}</td>`;
            } else {
                rowHtml += `<td class="val-zero">-</td>`;
            }
        });

        rowHtml += `<td class="balance-col">${parseFloat(runningBalance.toFixed(2))}</td></tr>`;
        tbody += rowHtml;
    });

    // [Fix 3] Sanity Check Warning (Append to tbody if mismatch)
    // Only check if ALL warehouses are selected (otherwise mismatch is expected)
    const allWhsSelected = checkedWhs.length === matState.warehouses.length;
    if (allWhsSelected && Math.abs(runningBalance - liveStockTotal) > 0.01) {
        tbody += `
            <tr style="background:#fef2f2; border:2px solid #ef4444;">
                <td colspan="${5 + checkedWhs.length}" style="color:#b91c1c; font-weight:bold; padding:15px;">
                    <i class="fas fa-exclamation-triangle"></i> تنبيه: الرصيد المحسوب (${parseFloat(runningBalance.toFixed(2))}) يختلف عن الرصيد الفعلي المسجل (${parseFloat(liveStockTotal.toFixed(2))}). يرجى إجراء جرد.
                </td>
            </tr>
        `;
    }

    tbody += `</tbody>`;
    table.innerHTML += tbody;

    // 7. Update Cards
    document.getElementById('sum-start-bal').textContent = parseFloat(startBal.toFixed(2));
    document.getElementById('sum-total-in').textContent = '+' + parseFloat(totalIn.toFixed(2));
    document.getElementById('sum-total-out').textContent = '-' + parseFloat(totalOut.toFixed(2));
    document.getElementById('sum-end-bal').textContent = parseFloat(runningBalance.toFixed(2));
}

// --- REPORT HELPERS ---

// 1. GROUPING LOGIC (Strict TRF Matching for Fix #6)
function groupTransactions(raw) {
    const grouped = [];
    const transferMap = new Map(); 
    
    // Pass 1: Identify and Group Transfers
    raw.forEach(tx => {
        // [Fix 6] Strict Regex to find TRF-123456-IN or TRF-123456-OUT
        // This ensures we don't accidentally split wrong IDs
        const match = tx.id ? tx.id.match(/^(TRF-\d+)-(IN|OUT)$/) : null;

        if (match) {
            const baseId = match[1]; // e.g. TRF-123456
            
            if (!transferMap.has(baseId)) {
                transferMap.set(baseId, {
                    id: baseId,
                    date: tx.date, // Takes date of first part found
                    displayType: 'TRANSFER',
                    notes: 'تحويل مخزني',
                    whEffects: {},
                    cost: tx.cost // Keep track of cost
                });
            }
            
            const group = transferMap.get(baseId);
            group.whEffects[tx.whId] = tx.qtyChange;
            
            // Improve notes: If this is the OUT part, use its specific note (usually contains "To WH...")
            if(match[2] === 'OUT') {
                group.notes = tx.notes.replace('Transfer to', 'إلى');
                // Use the OUT cost as the main cost for the row
                if(tx.cost) group.cost = tx.cost; 
            }
        }
    });

    const processedTransferIds = new Set();

    // Pass 2: Build Final List
    raw.forEach(tx => {
        const match = tx.id ? tx.id.match(/^(TRF-\d+)-(IN|OUT)$/) : null;

        if (match) {
            const baseId = match[1];
            // Only add the grouped object ONCE
            if (!processedTransferIds.has(baseId) && transferMap.has(baseId)) {
                grouped.push(transferMap.get(baseId));
                processedTransferIds.add(baseId);
            }
        } else {
            // Standard Transaction (Opening, Adjust, etc.)
            let dispType = tx.type;
            if (tx.type.includes('ADJUSTMENT')) dispType = 'ADJUSTMENT';
            
            const simple = {
                id: tx.id,
                date: tx.date,
                displayType: dispType,
                notes: tx.notes,
                whEffects: {},
                cost: tx.cost
            };
            simple.whEffects[tx.whId] = tx.qtyChange;
            grouped.push(simple);
        }
    });

    return grouped;
}

// 2. FILTER LOGIC (Fixing the "Not Affected" issue)
function isTypeSelected(dispType, checkedTypes) {
    // Check strict match or prefix match
    if (checkedTypes.includes(dispType)) return true;
    
    // Handle sub-types mapping
    if (dispType.startsWith('TRANSFER') && checkedTypes.includes('TRANSFER')) return true;
    if (dispType.includes('ADJUSTMENT') && checkedTypes.includes('ADJUSTMENT')) return true;
    if (dispType === 'OPENING_BALANCE' && checkedTypes.includes('OPENING_BALANCE')) return true;
    
    // Future proofing
    if (dispType === 'PRODUCTION' && checkedTypes.includes('PRODUCTION')) return true;
    if (dispType === 'PURCHASE' && checkedTypes.includes('PURCHASE')) return true;
    if (dispType === 'RETURN' && checkedTypes.includes('RETURN')) return true;

    return false;
}

// 3. TRANSLATION (Arabic Labels)
function translateType(type) {
    const map = {
        'OPENING_BALANCE': 'رصيد افتتاحي',
        'TRANSFER': 'تحويل مخزني',
        'TRANSFER_OUT': 'تحويل (صادر)',
        'TRANSFER_IN': 'تحويل (وارد)',
        'ADJUSTMENT': 'تسوية',
        'ADJUSTMENT_IN': 'تسوية (+)',
        'ADJUSTMENT_OUT': 'تسوية (-)',
        'PRODUCTION': 'إنتاج',
        'PURCHASE': 'مشتريات',
        'RETURN': 'مرتجع مورد'
    };
    return map[type] || type;
}

function getNetEffect(tx, checkedWhs) {
    let net = 0;
    for (const [whId, qty] of Object.entries(tx.whEffects)) {
        if (checkedWhs.includes(whId)) {
            net += qty;
        }
    }
    return net;
}

function isTransactionRelevant(tx, checkedWhs) {
    // Is any of the affected WHs in the checked list?
    return Object.keys(tx.whEffects).some(wh => checkedWhs.includes(wh));
}

function exportReportToExcel() {
    const table = document.getElementById('report-table');
    const refName = document.getElementById('report-title').textContent;
    const refId = document.getElementById('report-subtitle').textContent;
    const filename = `Report_${refId}_${new Date().toISOString().slice(0,10)}.xls`;

    let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="UTF-8">
            <style>
                table { border-collapse: collapse; width: 100%; font-family: 'Arial'; direction: rtl; }
                th { background-color: #2563eb; color: #fff; border: 1px solid #000; padding: 10px; }
                td { border: 1px solid #ccc; padding: 8px; text-align: center; }
                .val-pos { color: green; } .val-neg { color: red; } .balance-col { background-color: #f0f9ff; font-weight: bold; }
            </style>
        </head>
        <body>
            <h3>تقرير حركة صنف: ${refName} (${refId})</h3>
            ${table.outerHTML}
        </body>
        </html>
    `;

    const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function renderStockTable() {
    const gridContainer = document.getElementById('mat-stock-grid');
    const whFilter = document.getElementById('mat-filter-wh').value;
    const search = document.getElementById('mat-filter-search').value.toLowerCase();
    
    // Auto-expand if the user is searching for something
    const isSearchActive = search.trim().length > 0;

    gridContainer.innerHTML = '';
    
    // 1. Aggregate Data by RefID
    const groupedMap = new Map();
    matState.stock.forEach(item => {
        if (whFilter !== 'ALL' && item.whId !== whFilter) return;
        const matchName = item.name.toLowerCase().includes(search) || item.refId.toLowerCase().includes(search);
        if (!matchName) return;

        if (!groupedMap.has(item.refId)) {
            groupedMap.set(item.refId, {
                refId: item.refId,
                name: item.name,
                totalQty: 0,
                reorderPoint: item.reorderPoint,
                breakdown: [] 
            });
        }
        const group = groupedMap.get(item.refId);
        group.totalQty += item.qty;
        group.breakdown.push({ whId: item.whId, qty: item.qty });
    });

    if (groupedMap.size === 0) {
        gridContainer.innerHTML = `
            <div style="text-align:center; padding:50px; background:#fff; border-radius:12px; border:1px solid #e2e8f0; color:#64748b;">
                <i class="fas fa-search fa-3x" style="opacity:0.2;"></i><br><br>لا توجد نتائج مطابقة
            </div>`;
        return;
    }

    // 2. Render Groups
    matState.materialsGrouped.forEach(mainGroup => {
        const groupItems = [];
        if (mainGroup.variations) {
            mainGroup.variations.forEach(v => {
                if (groupedMap.has(v.id)) {
                    groupItems.push(groupedMap.get(v.id));
                    groupedMap.delete(v.id); 
                }
            });
        }

        if (groupItems.length > 0) {
            const groupTotalQty = groupItems.reduce((sum, item) => sum + item.totalQty, 0);
            const groupReorder = mainGroup.reorder || 0;
            // PASS isSearchActive to decide expansion
            renderGridSection(gridContainer, mainGroup.name, groupItems, groupTotalQty, groupReorder, isSearchActive);
        }
    });

    // 3. Render Uncategorized
    if (groupedMap.size > 0) {
        const items = Array.from(groupedMap.values());
        const total = items.reduce((sum, i) => sum + i.totalQty, 0);
        renderGridSection(gridContainer, "أصناف أخرى", items, total, 0, isSearchActive);
    }
}

// Updated Helper: Now accepts shouldExpand param
function renderGridSection(container, title, items, totalQty, reorderPoint, shouldExpand) {
    const section = document.createElement('div');
    // Default to 'collapsed' unless shouldExpand is true
    section.className = shouldExpand ? 'mat-grid-section' : 'mat-grid-section collapsed';
    
    // --- STATUS FLAG LOGIC ---
    let statusHtml = '';
    if (reorderPoint > 0) {
        if (totalQty < reorderPoint) {
            statusHtml = `
                <span style="background:#fee2e2; color:#b91c1c; padding:4px 10px; border-radius:20px; font-size:0.75rem; display:flex; align-items:center; gap:5px; border:1px solid #fecaca;">
                    <i class="fas fa-exclamation-circle"></i> رصيد منخفض
                </span>`;
        } else if (totalQty < (reorderPoint * 1.15)) {
            statusHtml = `
                <span style="background:#fef3c7; color:#b45309; padding:4px 10px; border-radius:20px; font-size:0.75rem; display:flex; align-items:center; gap:5px; border:1px solid #fde68a;">
                    <i class="fas fa-exclamation-triangle"></i> حد الطلب
                </span>`;
        } else {
             statusHtml = `
                <span style="background:#dcfce7; color:#15803d; padding:4px 10px; border-radius:20px; font-size:0.75rem; display:flex; align-items:center; gap:5px; border:1px solid #bbf7d0;">
                    <i class="fas fa-check-circle"></i> آمن
                </span>`;
        }
    }

    // [FIX] Removed dynamic window function generation. Used static onclick.
    section.innerHTML = `
        <div class="mat-grid-header" onclick="toggleGridSection(this)" style="justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fas fa-chevron-down grid-chevron"></i>
                <i class="fas fa-layer-group" style="color:#2563eb; opacity:0.8;"></i> 
                ${title}
                <span style="font-size:0.8rem; font-weight:normal; color:#94a3b8; background:#f1f5f9; padding:2px 8px; border-radius:4px;">${items.length}</span>
            </div>
            <div>${statusHtml}</div>
        </div>
    `;

    // Cards Grid
    const grid = document.createElement('div');
    grid.className = 'mat-grid-cards';

    items.forEach(item => {
        const safeRef = String(item.refId).replace(/'/g, "\\'").replace(/\n/g, "");
        const safeName = String(item.name).replace(/'/g, "\\'").replace(/\n/g, " ");
        const breakdownHtml = encodeURIComponent(JSON.stringify(item.breakdown));

        const card = document.createElement('div');
        card.className = 'mat-stock-card';
        card.innerHTML = `
            <div class="card-top">
                <span class="card-ref">${item.refId}</span>
                <button class="btn-action-icon" onclick="openReportModal('${safeRef}', '${safeName}'); event.stopPropagation();" title="عرض السجل">
                    <i class="fas fa-history"></i>
                </button>
            </div>
            <div class="card-name" title="${item.name}">${item.name}</div>
            <div class="card-stats">
                <div class="card-qty-wrapper">
                    <span class="card-lbl">الإجمالي</span>
                    <span class="card-total-chip" onclick="toggleWhPopover(event, '${breakdownHtml}')">
                        ${parseFloat(item.totalQty.toFixed(2))}
                    </span>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });

    section.appendChild(grid);
    container.appendChild(section);
}

// Global toggle handler (fixes ReferenceError)
function toggleGridSection(headerEl) {
    const section = headerEl.parentElement; // The header is inside the section div
    if(section) {
        section.classList.toggle('collapsed');
    }
}

function populateWhSelects() {
    const filterSel = document.getElementById('mat-filter-wh');
    while (filterSel.options.length > 1) filterSel.remove(1);
    
    const formSelects = document.querySelectorAll('.wh-select');
    formSelects.forEach(s => s.innerHTML = '<option value="">اختر المخزن...</option>');
    
    matState.warehouses.forEach(wh => {
      
        const opt = new Option(wh.name, wh.id);
        filterSel.add(opt);
        
        formSelects.forEach(sel => {
            const formOpt = new Option(wh.name, wh.id);
            // Optional: Store color in dataset if you ever custom render it
            formOpt.dataset.color = getWhColor(wh.color);
            sel.add(formOpt);
        });
    });
}

function populateDataLists() {
    const mainList = document.getElementById('global-main-list');
    mainList.innerHTML = '';
    matState.materialsGrouped.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.name;
        mainList.appendChild(opt);
    });
    const flatList = document.getElementById('global-mat-list');
    flatList.innerHTML = '';
    matState.materialsGrouped.forEach(g => {
        if(g.variations) {
            g.variations.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.label = `${g.name} - ${v.label}`;
                flatList.appendChild(opt);
            });
        }
    });
}

function addTransferRow() {
    matState.transferRowCount++;
    const rowId = `tx-row-${matState.transferRowCount}`;
    const div = document.createElement('div');
    div.className = 'batch-row';
    div.id = rowId;
    
    // Updated HTML: Added Layer Select Column (Middle)
    div.innerHTML = `
        <div style="text-align:center; color:#94a3b8; font-weight:bold;">${matState.transferRowCount}</div>
        
        <div>
            <input class="mat-input-compact main-input" list="global-main-list" 
                   placeholder="بحث..." onchange="onMainInput(this, '${rowId}')">
        </div>
        
        <div>
            <input class="mat-input-compact var-input" list="var-list-${rowId}" 
                   placeholder="النوع..." onchange="onVarInput(this, '${rowId}')" disabled>
            <datalist id="var-list-${rowId}"></datalist>
            <input type="hidden" class="final-ref-id">
        </div>

        <div>
            <select class="layer-select" id="layer-${rowId}" onchange="validateLayerQty('${rowId}')" disabled>
                <option value="">(اختر الصنف أولاً)</option>
            </select>
        </div>
        
        <div style="display:flex; align-items:center; gap:8px;">
            <input type="number" class="mat-input-compact qty-input" placeholder="0" step="0.01" style="width:80px;" oninput="validateLayerQty('${rowId}')">
            <span class="stock-pill none" id="chip-${rowId}">-</span>
        </div>
        
        <div style="text-align:center;">
            <button type="button" class="btn-icon-only" onclick="removeTransferRow('${rowId}')" style="color:#ef4444;">
                <i class="fas fa-times-circle"></i>
            </button>
        </div>
        
        <div id="error-${rowId}" class="error-msg-tooltip" style="display:none;"></div>
    `;
    
    document.getElementById('transfer-rows-container').appendChild(div);
}

function submitBatchTransferFinal(items) {
    const btn = document.getElementById('btn-submit-transfer');
    const orig = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحويل...';
    btn.disabled = true;

    // Capture rows before request
    const rowElements = Array.from(document.querySelectorAll('.batch-row'));
    const activeRowElements = rowElements.filter(r => {
        const refId = r.querySelector('.final-ref-id').value;
        const qty = r.querySelector('.qty-input').value;
        return refId && qty > 0;
    });

    const payload = {
        sourceWh: document.getElementById('tx-source-wh').value,
        destWh: document.getElementById('tx-dest-wh').value,
        items: items // items now contains { refId, qty, layerId }
    };

    google.script.run
        .withSuccessHandler(res => {
            btn.innerHTML = orig;
            btn.disabled = false;
            
            // Clear visual error states
            document.querySelectorAll('.error-msg-tooltip').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.batch-row').forEach(el => el.classList.remove('error-row'));

            if (res.processedIndices && res.processedIndices.length > 0) {
                // Remove ONLY successful rows
                const indicesToRemove = res.processedIndices.sort((a, b) => b - a);
                indicesToRemove.forEach(idx => {
                    if(activeRowElements[idx]) activeRowElements[idx].remove();
                });
                
                // FIX: Refresh data but PRESERVE the remaining form rows
                loadMaterialsData(true); 
            }

            if (res.failures && res.failures.length > 0) {
                // Highlight failed rows
                res.failures.forEach(fail => {
                    const row = activeRowElements[fail.index];
                    if (row) {
                        row.classList.add('error-row');
                        const errDiv = row.querySelector('.error-msg-tooltip');
                        if (errDiv) {
                            errDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${fail.message}`;
                            errDiv.style.display = 'flex';
                        }
                    }
                });
                if(typeof showToast === 'function') showToast(res.message, 'error');
                else alert(res.message);
                
                // Even if failed, we refresh data to show latest stock (preserve form)
                if(!res.processedIndices || res.processedIndices.length === 0) {
                    loadMaterialsData(true);
                }

            } else {
                // Complete Success
                if(typeof showToast === 'function') showToast(res.message, 'success');
                
                // If all rows removed, add a fresh one
                if (document.getElementById('transfer-rows-container').children.length === 0) {
                    addTransferRow();
                }
            }
        })
        .submitBatchTransfer(payload);
}

function removeTransferRow(id) {
    const row = document.getElementById(id);
    if(row) row.remove();
}

function initManualAdjustTab() {
    // Set Date to Today
    document.getElementById('manual-adj-date').value = new Date().toISOString().split('T')[0];
    
    // Clear and Add First Row
    document.getElementById('manual-adjust-rows').innerHTML = '';
    matState.adjRowCount = 0;
    addAdjustmentRow();
}

function onMainInput(input, rowId) {
    const val = input.value;
    const row = document.getElementById(rowId);
    const varInput = row.querySelector('.var-input');
    const varList = row.querySelector(`#var-list-${rowId}`);
    varInput.value = ''; varInput.disabled = true; varList.innerHTML = ''; row.querySelector('.final-ref-id').value = ''; updateStockChip(rowId);
    const group = matState.materialsGrouped.find(g => g.name === val);
    if (group && group.variations) {
        group.variations.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.label; opt.dataset.id = v.id;
            varList.appendChild(opt);
        });
        varInput.disabled = false; varInput.focus();
    }
}

function onVarInput(input, rowId) {
    const val = input.value;
    const row = document.getElementById(rowId);
    const hiddenId = row.querySelector('.final-ref-id');
    const mainVal = row.querySelector('.main-input').value;
    const group = matState.materialsGrouped.find(g => g.name === mainVal);
    
    if (group) {
        const variant = group.variations.find(v => v.label === val);
        if (variant) { 
            hiddenId.value = variant.id; 
            updateStockChip(rowId); 
            // NEW: Fetch Layers
            fetchLayersForRow(rowId, variant.id);
            return; 
        }
    }
    hiddenId.value = ''; 
    updateStockChip(rowId);
    // Reset Layer Select
    const layerSel = document.getElementById(`layer-${rowId}`);
    if (layerSel) {
        layerSel.innerHTML = '<option value="">(اختر الصنف أولاً)</option>';
        layerSel.disabled = true;
    }
}

// Fetch Layers from Backend (JSON Parsed)
function fetchLayersForRow(rowId, refId) {
    const whId = document.getElementById('tx-source-wh').value;
    if (!whId) return;

    const layerSel = document.getElementById(`layer-${rowId}`);
    if (!layerSel) return;

    layerSel.innerHTML = '<option>جاري التحميل...</option>';

    google.script.run
    .withSuccessHandler(jsonString => {
        layerSel.innerHTML = '';
        let layers = [];
        
        // 1. Safe Parse
        try {
            layers = JSON.parse(jsonString);
        } catch (e) {
            console.error("JSON Parse Error", e);
        }

        // 2. Validation
        if (!layers || layers.length === 0) {
            layerSel.innerHTML = '<option value="">لا يوجد رصيد (0)</option>';
            layerSel.disabled = true;
            return;
        }

        // 3. Populate
        layerSel.disabled = false;
        layers.forEach((l, idx) => {
            const dateStr = new Date(l.date).toLocaleDateString('en-GB');
            // Format: [01/01] Qty:50 @ 10.00
            const label = `[${dateStr}] Qty:${l.qty} @ ${l.cost.toFixed(2)}`;
            const opt = new Option(label, l.id);
            opt.dataset.max = l.qty;
            layerSel.add(opt);
        });

        // 4. Auto-select Oldest
        layerSel.selectedIndex = 0;
        validateLayerQty(rowId);
    })
    .withFailureHandler(err => {
        layerSel.innerHTML = '<option value="">خطأ في التحميل</option>';
        console.error("Layer Fetch Error: ", err);
    })
    .getOpenLayers(refId, whId);
}

// Validate Quantity against Selected Layer
function validateLayerQty(rowId) {
    const row = document.getElementById(rowId);
    const layerSel = document.getElementById(`layer-${rowId}`);
    const qtyInput = row.querySelector('.qty-input');
    
    if (!layerSel || layerSel.selectedIndex === -1) return;
    
    const maxQty = parseFloat(layerSel.options[layerSel.selectedIndex]?.dataset.max || 0);
    const currentQty = parseFloat(qtyInput.value);

    // Set Max Attribute to prevent over-selection
    qtyInput.setAttribute('max', maxQty);

    if (currentQty > maxQty) {
        qtyInput.style.borderColor = 'red';
        qtyInput.title = `Max available in this batch is ${maxQty}`;
    } else {
        qtyInput.style.borderColor = '#cbd5e1';
        qtyInput.title = '';
    }
}

function updateStockChip(rowId) {
    const row = document.getElementById(rowId);
    const chip = document.getElementById(`chip-${rowId}`);
    const refId = row.querySelector('.final-ref-id').value;
    const sourceWh = document.getElementById('tx-source-wh').value;
    if (!refId || !sourceWh) { chip.className = 'stock-pill none'; chip.textContent = '-'; return; }
    const stockRec = matState.stock.find(s => s.refId === refId && s.whId === sourceWh);
    const qty = stockRec ? stockRec.qty : 0;
    chip.textContent = qty;
    chip.className = qty > 0 ? 'stock-pill ok' : 'stock-pill low';
}

function updateAllStockChips() {
    document.querySelectorAll('.batch-row').forEach(row => updateStockChip(row.id));
}

function preSubmitBatchTransfer() {
    const sourceWh = document.getElementById('tx-source-wh').value;
    const destWh = document.getElementById('tx-dest-wh').value;
    
    if (sourceWh === destWh) {
        alert('خطأ: لا يمكن التحويل لنفس المخزن. يرجى اختيار مخزن مختلف.');
        return;
    }

    const items = [];
    let isValid = true;

    document.querySelectorAll('.batch-row').forEach(row => {
        const refId = row.querySelector('.final-ref-id').value;
        const qty = parseFloat(row.querySelector('.qty-input').value);
        const layerSelect = row.querySelector('.layer-select');
        const layerId = layerSelect ? layerSelect.value : null;

        if (refId && qty > 0) {
            // Check Layer Limit
            if (layerSelect) {
                const max = parseFloat(layerSelect.selectedOptions[0]?.dataset.max || 0);
                if (qty > max) {
                    isValid = false;
                    alert(`خطأ: الكمية المطلوبة للصنف (${refId}) أكبر من المتاح في الباتش المحدد.`);
                    row.querySelector('.qty-input').style.borderColor = 'red';
                }
            }
            items.push({ refId, qty, specificLayerId: layerId });
        }
    });

    if (items.length === 0 || !isValid) { 
        alert('يرجى التأكد من اختيار الأصناف والكميات وصلاحية الأرصدة.'); 
        return; 
    }
    
    const msg = `سيتم تحويل ${items.length} أصناف من ${document.getElementById('tx-source-wh').selectedOptions[0].text} إلى ${document.getElementById('tx-dest-wh').selectedOptions[0].text}`;
    showMaterialConfirm('تأكيد التحويل المخزني', msg, true, function() { submitBatchTransferFinal(items); });
}


function submitAdjustmentFinal(formEl) {
    // 1. Setup Button & Animation
    const btn = formEl.querySelector('button'); 
    const originalBtnContent = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> جاري الحفظ...';
    btn.style.opacity = '0.7';

    // 2. Prepare Data
    const formData = new FormData(formEl); 
    const data = Object.fromEntries(formData.entries());
    
    // --- CRITICAL FIX: Handle Empty Cost ---
    // If string is empty, set to null. Otherwise keep value.
    let cleanCost = null;
    if (data.cost !== undefined && data.cost.trim() !== "") {
        cleanCost = data.cost;
    }

    const payload = {
        whId: data.whId,
        refId: data.refId,
        qty: Number(data.qty),
        cost: cleanCost,       // <--- Sends explicit null if blank
        subType: data.subType,
        txType: data.subType,
        notes: "Manual Adjustment: " + data.subType
    };

    // 3. Backend Call
    google.script.run
        .withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerHTML = originalBtnContent;
            btn.style.opacity = '1';

            if(res.success) {
                if(typeof showToast === 'function') showToast('تم الحفظ بنجاح', 'success');
                formEl.reset();
                const hintEl = document.getElementById('cost-hint-msg');
                if(hintEl) {
                    hintEl.innerHTML = '<i class="fas fa-info-circle"></i> اتركه فارغاً لاستخدام آخر سعر مسجل';
                    hintEl.style.color = '#64748b';
                }
                loadMaterialsData(true);
            } else { 
                if(typeof showToast === 'function') showToast(res.message, 'error');
                else alert(res.message);
            }
        })
        .withFailureHandler(err => {
            btn.disabled = false;
            btn.innerHTML = originalBtnContent;
            btn.style.opacity = '1';
            if(typeof showToast === 'function') showToast('خطأ في الاتصال: ' + err.message, 'error');
        })
        .submitMaterialTransaction(payload);
}

function showMaterialConfirm(title, message, showButtons, onConfirm, onCancel) {
    if (document.getElementById('mat-confirm-overlay')) return;
    document.body.style.overflow = 'hidden';
    const backdrop = document.createElement('div');
    backdrop.className = 'custom-confirm-backdrop';
    backdrop.id = 'mat-confirm-overlay';
    const modal = document.createElement('div');
    modal.className = 'custom-confirm-modal';
    modal.innerHTML = `
        <div class="custom-confirm-header"><h4>${title}</h4></div>
        <div class="custom-confirm-body"><p style="white-space: pre-line;">${message}</p></div>
        <div class="custom-confirm-footer">
            ${showButtons ? `<button class="btn-mat btn-ghost" onclick="closeMaterialConfirm(false)"><i class="fas fa-times"></i> إلغاء</button><button class="btn-mat btn-primary" onclick="closeMaterialConfirm(true)"><i class="fas fa-check"></i> تأكيد</button>` : `<button class="btn-mat btn-primary" onclick="closeMaterialConfirm(false)"><i class="fas fa-check"></i> موافق</button>`}
        </div>`;
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    window.matConfirmCallback = onConfirm; window.matCancelCallback = onCancel;
}

function closeMaterialConfirm(confirmed) {
    const backdrop = document.getElementById('mat-confirm-overlay');
    if (backdrop) backdrop.remove();
    document.body.style.overflow = '';
    if (confirmed && window.matConfirmCallback) window.matConfirmCallback();
    else if (!confirmed && window.matCancelCallback) window.matCancelCallback();
    window.matConfirmCallback = null; window.matCancelCallback = null;
}

// --- WAREHOUSE FILTERING LOGIC ---

function onSourceWhChange() {
    // 1. Update Stock Chips (Existing logic)
    updateAllStockChips();
    
    // 2. Filter Destination Dropdown (New logic)
    filterDestOptions();
}

function filterDestOptions() {
    const sourceVal = document.getElementById('tx-source-wh').value;
    const destSelect = document.getElementById('tx-dest-wh');
    const currentDest = destSelect.value;
    
    // Clear Destination Options
    destSelect.innerHTML = '<option value="">اختر المخزن...</option>';
    
    // Re-populate from global state, skipping the selected Source
    matState.warehouses.forEach(wh => {
        if (wh.id !== sourceVal) {
            const opt = new Option(wh.name, wh.id);
            destSelect.add(opt);
        }
    });
    
    // Restore previous selection if it wasn't the excluded one
    if (currentDest && currentDest !== sourceVal) {
        destSelect.value = currentDest;
    } else {
        destSelect.value = ""; // Reset if invalid
    }
}

// --- SMART POPOVER LOGIC ---
let popoverEl = null;
let activeChip = null; // Track currently active element

function toggleWhPopover(e, breakdownJson) {
    e.stopPropagation(); // Stop click from bubbling to document
    
    const targetChip = e.currentTarget;

    // 1. If clicking the same chip, close it
    if (activeChip === targetChip) {
        closeWhPopover();
        return;
    }

    // 2. If clicking a different chip, close old one first
    if (activeChip) {
        closeWhPopover();
    }

    // 3. Highlight new chip
    activeChip = targetChip;
    activeChip.classList.add('active');

    // 4. Create/Get Popover
    if (!popoverEl) {
        popoverEl = document.createElement('div');
        popoverEl.className = 'wh-popover';
        // Prevent clicks inside popover from closing it
        popoverEl.onclick = (ev) => ev.stopPropagation();
        document.body.appendChild(popoverEl);
    }

    // 5. Build Content
    const breakdown = JSON.parse(decodeURIComponent(breakdownJson));
    let html = '';
    breakdown.forEach(b => {
        const whObj = matState.warehouses.find(w => w.id === b.whId);
        const whName = whObj ? whObj.name : b.whId;
        const whColor = whObj ? getWhColor(whObj.color) : '#ccc';
        
        html += `
            <div class="popover-row">
                <span class="pop-wh">
                    <span class="wh-dot" style="background:${whColor}"></span>
                    ${whName}
                </span>
                <span class="pop-qty">${b.qty}</span>
            </div>
        `;
    });
    popoverEl.innerHTML = html;

    // 6. Smart Positioning Engine
    // First, show it but hidden to measure dimensions
    popoverEl.style.display = 'block';
    popoverEl.style.visibility = 'hidden';

    const rect = targetChip.getBoundingClientRect();
    const popRect = popoverEl.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const margin = 10;

    // Default: Align Left, Show Below
    let top = rect.bottom + 5;
    let left = rect.left;

    // Check Horizontal Overflow (Right side)
    if (left + popRect.width > viewportWidth - margin) {
        // Align to right edge of trigger instead
        left = rect.right - popRect.width;
        
        // If still overflowing left, just pin to right margin
        if (left < margin) left = viewportWidth - popRect.width - margin;
    }

    // Check Vertical Overflow (Bottom side)
    if (top + popRect.height > viewportHeight - margin) {
        // Flip to Top
        top = rect.top - popRect.height - 5;
    }

    // Apply Calculated Positions
    popoverEl.style.top = top + 'px';
    popoverEl.style.left = left + 'px';
    popoverEl.style.visibility = 'visible';
}

function closeWhPopover() {
    if (popoverEl) popoverEl.style.display = 'none';
    if (activeChip) {
        activeChip.classList.remove('active');
        activeChip = null;
    }
}

// Global Click Listener to close popover when clicking outside
document.addEventListener('click', function(e) {
    // Logic handled inside toggleWhPopover (stopPropagation) covers the chip click.
    // This handles clicks anywhere else on the page.
    closeWhPopover();
});
// --- GLOBAL SEARCH MODAL ---

function openGlobalSearchModal() {
    document.getElementById('mat-search-modal').style.display = 'flex';
    document.getElementById('global-search-input').value = '';
    document.getElementById('global-search-input').focus();
}

function closeGlobalSearchModal() {
    document.getElementById('mat-search-modal').style.display = 'none';
}

function submitGlobalSearch() {
    const val = document.getElementById('global-search-input').value;
    if(!val) return;
    
    // Find item in grouped list to get Name/Ref
    let found = null;
    
    // Search in groups structure
    for(let g of matState.materialsGrouped) {
        if(g.variations) {
            const v = g.variations.find(v => v.id === val || (g.name + ' - ' + v.label) === val);
            if(v) {
                found = { refId: v.id, name: g.name + ' - ' + v.label };
                break;
            }
        }
    }
    
    if(found) {
        closeGlobalSearchModal();
        openReportModal(found.refId, found.name);
    } else {
        // Try exact Ref ID match if manual entry
        closeGlobalSearchModal();
        openReportModal(val, 'خامة محددة');
    }
}

// --- LOGIC: BATCH EXCEL GENERATION (Fixed v3) ---
async function downloadStockTakeTemplate() {
    const dateVal = document.getElementById('batch-date-picker').value;
    if(!dateVal) return alert('يرجى اختيار تاريخ الجرد أولاً');

    const btn = event.currentTarget;
    const origHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التجهيز...';

    // 1. Prepare Workbook
    const workbook = new ExcelJS.Workbook();
    
    // 2. Iterate Warehouses -> Create Sheet for Each
    matState.warehouses.forEach(wh => {
        const sheet = workbook.addWorksheet(wh.name);
        
        // Headers
        sheet.columns = [
            { header: 'Ref ID', key: 'refId', width: 15 },
            { header: 'Item Name', key: 'name', width: 35 },
            { header: 'System Qty', key: 'sysQty', width: 12 },
            { header: 'System Cost', key: 'sysCost', width: 12 },
            { header: 'ACTUAL Qty', key: 'actQty', width: 15 },
            { header: 'ACTUAL Cost', key: 'actCost', width: 15 },
            { header: 'Diff', key: 'diff', width: 10 },
            { header: 'Notes', key: 'notes', width: 25 }
        ];

        // Style Header
        sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
        sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E293B' } };

        // 3. Populate Rows
        const allItems = [];
        matState.materialsGrouped.forEach(g => {
            if(g.variations) g.variations.forEach(v => allItems.push({ 
                id: v.id, 
                name: `${g.name} - ${v.label}` 
            }));
        });

        allItems.forEach((item, index) => {
            const stockRec = matState.stock.find(s => s.refId === item.id && s.whId === wh.id);
            const qty = stockRec ? stockRec.qty : 0;
            const value = stockRec ? stockRec.value : 0;
            
            // Calculate System Cost
            const cost = (qty !== 0 && value !== 0) ? (value / qty) : 0;

            const row = sheet.addRow({
                refId: item.id,
                name: item.name,
                sysQty: qty,
                sysCost: parseFloat(cost.toFixed(2)),
                actQty: '', 
                actCost: '',
                notes: ''
            });

            // Formula: IF(E is blank, blank, E - C)
            const r = index + 2;
            sheet.getCell(`G${r}`).value = { formula: `IF(E${r}="","",E${r}-C${r})` };
        });

        // 4. Conditional Formatting (Fixed: used 'formulae' instead of 'formula')
        const rowCount = allItems.length;
        
        // Set Default Orange Background
        for(let i=2; i <= rowCount+1; i++) {
            ['E', 'F'].forEach(col => {
                const cell = sheet.getCell(`${col}${i}`);
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFE0B2' } };
                cell.border = { bottom: {style:'thin', color: {argb:'FFEEEEEE'}} };
            });
        }

        // Rule: Turn WHITE if cell is NOT BLANK
        sheet.addConditionalFormatting({
            ref: `E2:F${rowCount+1}`,
            rules: [
                {
                    type: 'cellIs',
                    operator: 'notEqual',
                    formulae: ['""'], // <--- FIXED: Must be 'formulae' (plural)
                    style: { fill: { type: 'pattern', pattern: 'solid', bgColor: { argb: 'FFFFFFFF' } } }
                }
            ]
        });
        
        // Rule: Red Text for Negative Diff
        sheet.addConditionalFormatting({
            ref: `G2:G${rowCount+1}`,
            rules: [
                {
                    type: 'expression',
                    formulae: [`G2<0`], // <--- FIXED: Must be 'formulae' (plural)
                    style: { font: { color: { argb: 'FFDC2626' }, bold: true } }
                }
            ]
        });
    });

    // 5. Add Hidden Metadata Sheet
    const metaSheet = workbook.addWorksheet('METADATA');
    metaSheet.state = 'hidden';
    metaSheet.getCell('A1').value = 'StockTakeDate';
    metaSheet.getCell('B1').value = dateVal;

    // 6. Download
    const buffer = await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), `StockTake_${dateVal}.xlsx`);
    
    btn.innerHTML = origHtml;
}

// --- LOGIC: BATCH PARSING ---
async function handleBatchUpload(input) {
    if(!input.files.length) return;
    const file = input.files[0];
    
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.load(file);

    // 1. Get Date
    const metaSheet = workbook.getWorksheet('METADATA');
    let batchDate = new Date();
    if(metaSheet) {
        batchDate = metaSheet.getCell('B1').value;
    }

    matState.batchDate = batchDate;
    matState.batchPreview = [];

    // 2. Iterate Sheets
    workbook.eachSheet((sheet, id) => {
        if(sheet.name === 'METADATA') return;

        // Try to find Warehouse ID by Name
        const whObj = matState.warehouses.find(w => w.name === sheet.name);
        if(!whObj) return; // Skip unknown sheets

        sheet.eachRow((row, rowNumber) => {
            if(rowNumber === 1) return; // Skip Header

            // Cols: A=Ref, B=Name, C=Sys, D=Cost, E=ACTUAL(5), F=ActCost(6), H=Notes(8)
            const refId = row.getCell(1).value;
            const actQtyRaw = row.getCell(5).value;
            const actCostRaw = row.getCell(6).value;
            const notes = row.getCell(8).value;

            // Filter: Ignore if Actual Qty is blank/null (but keep 0)
            if(actQtyRaw === null || actQtyRaw === '' || actQtyRaw === undefined) return;

            const actQty = Number(actQtyRaw);
            const sysQty = Number(row.getCell(3).value || 0);
            
            // Only add if there is a difference OR if user explicitly entered 0 to clear stock
            // Actually, "Opening Balance" logic enforces the number regardless.
            // But visually, we highlight diffs.
            
            matState.batchPreview.push({
                whId: whObj.id,
                whName: whObj.name,
                refId: refId,
                name: row.getCell(2).value,
                sysQty: sysQty,
                actQty: actQty,
                diff: actQty - sysQty,
                cost: actCostRaw,
                notes: notes
            });
        });
    });

    renderBatchPreview();
    document.getElementById('batch-preview-container').classList.remove('hidden');
    input.value = ''; // Reset input
}

function renderBatchPreview() {
    const tbody = document.querySelector('#batch-preview-table tbody');
    tbody.innerHTML = '';

    matState.batchPreview.forEach(row => {
        // Skip rows with exact match to reduce noise? 
        // No, user might want to confirm they matched. 
        // But for performance, let's filter visual noise if list is huge?
        // Let's show all for now.

        const tr = document.createElement('tr');
        if(row.diff === 0) tr.classList.add('row-ok'); // Greenish if matched
        
        tr.innerHTML = `
            <td>${row.whName}</td>
            <td>${row.name} <small style="color:#64748b">(${row.refId})</small></td>
            <td>${row.sysQty}</td>
            <td style="font-weight:bold">${row.actQty}</td>
            <td class="${row.diff !== 0 ? 'row-diff' : 'row-match'}">
                ${row.diff > 0 ? '+' : ''}${parseFloat(row.diff.toFixed(2))}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- LOGIC: SUBMIT BATCH ---
function submitBatchToBackend() {
    if(matState.batchPreview.length === 0) return alert('لا توجد بيانات لاعتمادها');
    
    // Filter: Only send rows where Diff != 0?
    // "Opening Balance" logic is idempotent. Sending 50 when it's already 50 does nothing.
    // So sending all is safe, but skipping 0 diffs saves server processing.
    const payloadRows = matState.batchPreview.filter(r => Math.abs(r.diff) > 0.0001).map(r => ({
        refId: r.refId,
        whId: r.whId,
        qty: r.actQty, // Target
        cost: r.cost,
        notes: r.notes
    }));

    if(payloadRows.length === 0) return alert('جميع الأرصدة مطابقة! لا توجد فروقات للحفظ.');

    const btn = event.currentTarget;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    btn.disabled = true;

    google.script.run
        .withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-double"></i> اعتماد الفروقات';
            
            if(res.failed > 0) {
                alert(`تم الحفظ مع بعض الأخطاء:\nنجح: ${res.success}\nفشل: ${res.failed}\nCheck logs.`);
            } else {
                alert(`تم تحديث الأرصدة بنجاح (${res.success} صنف)`);
                document.getElementById('batch-preview-container').classList.add('hidden');
                loadMaterialsData(true); // Refresh
            }
        })
        .processStockTakeBatch({
            date: matState.batchDate,
            rows: payloadRows
        });
}

function addAdjustmentRow() {
    matState.adjRowCount++;
    const rowId = `adj-row-${matState.adjRowCount}`;
    
    const div = document.createElement('div');
    div.className = 'adj-row';
    div.id = rowId;

    // Generate Warehouse Options
    let whOpts = '<option value="" disabled selected>اختر...</option>';
    matState.warehouses.forEach(w => whOpts += `<option value="${w.id}">${w.name}</option>`);

    div.innerHTML = `
        <div>
            <select class="adj-input row-wh" onchange="calcAdjRow('${rowId}')">${whOpts}</select>
        </div>
        
        <div>
            <input list="global-mat-list" class="adj-input row-item" placeholder="بحث..." onchange="calcAdjRow('${rowId}')">
            <input type="hidden" class="row-ref-id">
        </div>

        <div class="adj-status-box" id="status-${rowId}">
            <span class="curr-lbl">Curr: -</span>
            <span class="diff-lbl diff-zero">Diff: 0</span>
        </div>

        <div>
            <input type="number" class="adj-input row-qty" step="0.01" placeholder="Target" oninput="calcAdjRow('${rowId}')">
        </div>

        <div>
            <input type="number" class="adj-input row-cost" step="0.01" placeholder="Auto">
        </div>

        <div>
            <input type="text" class="adj-input row-note" placeholder="سبب التعديل...">
        </div>

        <div style="text-align:center;">
            <button class="btn-icon-only" onclick="removeAdjRow('${rowId}')" style="color:#ef4444;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    document.getElementById('manual-adjust-rows').appendChild(div);
}

function removeAdjRow(id) {
    const row = document.getElementById(id);
    if(row) row.remove();
}

function calcAdjRow(rowId) {
    const row = document.getElementById(rowId);
    if(!row) return;

    const whId = row.querySelector('.row-wh').value;
    const itemInput = row.querySelector('.row-item');
    const itemVal = itemInput.value;
    const targetInput = row.querySelector('.row-qty');
    const costInput = row.querySelector('.row-cost');
    const statusBox = document.getElementById(`status-${rowId}`);
    
    // Resolve Ref ID
    let refId = '';
    for(let g of matState.materialsGrouped) {
        if(g.variations) {
            const v = g.variations.find(v => v.id === itemVal || (g.name + ' - ' + v.label) === itemVal);
            if(v) refId = v.id;
        }
    }
    if(!refId && itemVal) refId = itemVal; 
    row.querySelector('.row-ref-id').value = refId;

    // Get Current Stock
    let currentQty = 0;
    if(whId && refId) {
        const stockRec = matState.stock.find(s => s.refId === refId && s.whId === whId);
        if(stockRec) currentQty = stockRec.qty;
    }

    // Calc Diff
    const targetQty = parseFloat(targetInput.value);
    let diff = 0;
    let diffHtml = '<span class="diff-lbl diff-zero">Diff: 0</span>';

    // Cleanup previous hints
    const oldHint = row.querySelector('.cost-hint');
    if(oldHint) oldHint.remove();

    if(!isNaN(targetQty)) {
        diff = targetQty - currentQty;
        if(diff > 0.0001) {
            // --- IN (Add Stock) ---
            diffHtml = `<span class="diff-lbl diff-pos">+${parseFloat(diff.toFixed(2))}</span>`;
            costInput.disabled = false;
            costInput.placeholder = "Required";
            
            // NEW: Fetch Last Cost Hint
            fetchLastCostHint(rowId, refId);

        } else if (diff < -0.0001) {
            // --- OUT (Remove Stock) ---
            diffHtml = `<span class="diff-lbl diff-neg">${parseFloat(diff.toFixed(2))}</span>`;
            costInput.disabled = true;  // Disable cost for OUT (FIFO)
            costInput.value = '';
            costInput.placeholder = "FIFO";
        } else {
            costInput.disabled = false;
            costInput.placeholder = "Auto";
        }
    }

    // Update UI
    statusBox.querySelector('.curr-lbl').textContent = `Curr: ${parseFloat(currentQty.toFixed(2))}`;
    const oldBadge = statusBox.querySelector('.diff-lbl');
    if(oldBadge) oldBadge.outerHTML = diffHtml;
}

// NEW HELPER: Fetch Cost Hint
function fetchLastCostHint(rowId, refId) {
    const row = document.getElementById(rowId);
    const costContainer = row.querySelector('.row-cost').parentElement;
    
    if(costContainer.querySelector('.cost-hint')) return;

    const hint = document.createElement('div');
    hint.className = 'cost-hint';
    hint.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    costContainer.appendChild(hint);

    google.script.run.withSuccessHandler(res => {
        if(res.success && res.cost > 0) {
            hint.innerHTML = `<i class="fas fa-tag"></i> Last: ${res.cost.toFixed(2)}`;
        } else {
            hint.innerHTML = `<i class="fas fa-info-circle"></i> No history`;
            hint.style.color = '#94a3b8';
        }
    }).api_getLastCost(refId);
}

// 4. Save All Logic (Uses Batch Backend)
function saveManualAdjustments() {
    const rows = document.querySelectorAll('.adj-row');
    const payloadRows = [];
    const dateVal = document.getElementById('manual-adj-date').value;

    if(!dateVal) return alert('يرجى تحديد التاريخ');

    rows.forEach(row => {
        const refId = row.querySelector('.row-ref-id').value;
        const whId = row.querySelector('.row-wh').value;
        const qtyVal = row.querySelector('.row-qty').value;
        const costVal = row.querySelector('.row-cost').value;
        const noteVal = row.querySelector('.row-note').value;

        // Validation
        if(refId && whId && qtyVal !== '') {
            payloadRows.push({
                refId: refId,
                whId: whId,
                qty: qtyVal, // Target Qty
                cost: costVal,
                notes: noteVal
            });
        }
    });

    if(payloadRows.length === 0) return alert('يرجى إضافة بيانات صحيحة (مخزن، صنف، كمية) لصف واحد على الأقل.');

    // UI Feedback
    const btn = event.currentTarget;
    const origHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    btn.disabled = true;

    // Reuse the Batch Backend Function!
    google.script.run
        .withSuccessHandler(res => {
            btn.innerHTML = origHtml;
            btn.disabled = false;

            if(res.failed > 0) {
                alert(`تم الحفظ مع أخطاء:\nنجح: ${res.success}\nفشل: ${res.failed}\n${res.errors.join('\n')}`);
            } else {
                if(typeof showToast === 'function') showToast(`تم حفظ ${res.success} عملية بنجاح`, 'success');
                else alert(`تم حفظ ${res.success} عملية بنجاح`);
                
                // Reset Form
                initManualAdjustTab();
                loadMaterialsData(true);
            }
        })
        .processStockTakeBatch({
            date: dateVal, // Uses selected date
            rows: payloadRows
        });
}
</script>
